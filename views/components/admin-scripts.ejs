<!-- Quill.js JS -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<!-- Content Type Change Handler -->
<%- include('admin-studio/content-type-change/script') %>
<script>
  // Initialiser Quill
  const quill = new Quill('#textEditor', {
    theme: 'snow',
    modules: {
      toolbar: [
        [{ 'header': [1, 2, 3, false] }],
        ['bold', 'italic', 'underline', 'strike'],
        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
        [{ 'color': [] }, { 'background': [] }],
        [{ 'align': [] }],
        ['link'],
        ['clean']
      ]
    },
    placeholder: 'Saisissez votre texte ici...'
  });

  // Charger le contenu existant dans l'éditeur si c'est du texte
  <% if (content && content.type === "text") { %>
  const existingContent = `<%- content.value %>`;
  if (existingContent) {
    quill.root.innerHTML = existingContent;
  }
  <% } %>

  // Gérer le changement de type de contenu
  const contentTypeSelect = document.getElementById('contentType');
  const textEditorContainer = document.getElementById('textEditorContainer');
  const regularValueInput = document.getElementById('regularValue');
  const nonTextValueSection = document.getElementById('nonTextValueSection');
  const imageUploadGroup = document.getElementById('imageUploadGroup');
  const regularValueGroup = document.getElementById('regularValueGroup');
  const regularValueHelper = document.getElementById('regularValueHelper');
  
  function updateValueInputs() {
    if (!contentTypeSelect) return;
    const currentType = contentTypeSelect.value;
    const isText = currentType === 'text';
    const isImage = currentType === 'image';
    
    if (textEditorContainer) {
      textEditorContainer.classList.toggle('hidden', !isText);
    }
    
    if (nonTextValueSection) {
      nonTextValueSection.classList.toggle('hidden', isText);
    }
    
    if (regularValueGroup) {
      regularValueGroup.classList.toggle('hidden', isText || isImage);
    }
    
    if (imageUploadGroup) {
      imageUploadGroup.classList.toggle('hidden', !isImage);
    }
    
    if (regularValueInput) {
      if (isImage) {
        regularValueInput.placeholder = '';
      } else if (currentType === 'video') {
        regularValueInput.placeholder = 'URL YouTube ou code embed';
      } else if (currentType === 'embed') {
        regularValueInput.placeholder = 'URL publique ou code d'intégration';
      } else {
        regularValueInput.placeholder = 'Collez le lien ou la valeur du contenu';
      }
    }
    
    if (regularValueHelper) {
      if (currentType === 'video') {
        regularValueHelper.textContent = 'Collez un lien YouTube ou un code d'intégration (iframe).';
      } else if (currentType === 'embed') {
        regularValueHelper.textContent = 'Collez l'URL ou l'iframe fourni par le service externe.';
      } else {
        regularValueHelper.textContent = 'Collez la valeur publique à afficher (URL, identifiant, etc.).';
      }
    }
  }
  
  // Initialiser le gestionnaire de changement de type avec le module centralisé
  if (window.AdminStudio && window.AdminStudio.ContentTypeChangeHandler && contentTypeSelect) {
    window.AdminStudio.ContentTypeChangeHandler.init({
      contentTypeSelect: contentTypeSelect,
      quill: quill,
      regularValueInput: regularValueInput,
      imageUploadGroup: imageUploadGroup,
      updateValueInputs: updateValueInputs
    });
  } else if (contentTypeSelect) {
    // Fallback si le module n'est pas disponible
    contentTypeSelect.addEventListener('change', function() {
      updateValueInputs();
    });
  }
  
  function initializeUploadField(container) {
    const fileInput = container.querySelector('input[type="file"]');
    const triggerButton = container.querySelector('[data-upload-trigger]');
    const dropzone = container.querySelector('[data-upload-dropzone]');
    const preview = container.querySelector('[data-upload-preview]');
    const previewImg = container.querySelector('[data-upload-preview-img]');
    
    const setPreview = (src) => {
      if (!preview || !previewImg) return;
      if (src) {
        previewImg.src = src;
        preview.classList.remove('hidden');
        preview.dataset.hasPreview = 'true';
      } else {
        previewImg.removeAttribute('src');
        preview.classList.add('hidden');
        preview.dataset.hasPreview = 'false';
      }
    };
    
    const handleFileSelection = (file) => {
      if (!file) {
        setPreview(null);
        return;
      }
      const reader = new FileReader();
      reader.onload = function(event) {
        const previewSrc = event.target?.result || '';
        setPreview(previewSrc || null);
      };
      reader.readAsDataURL(file);
    };
    
    if (triggerButton && fileInput) {
      triggerButton.addEventListener('click', () => fileInput.click());
    }
    
    if (dropzone && fileInput) {
      const preventDefaults = (e) => {
        e.preventDefault();
        e.stopPropagation();
      };
      
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach((eventName) => {
        dropzone.addEventListener(eventName, preventDefaults, false);
      });
      
      ['dragenter', 'dragover'].forEach((eventName) => {
        dropzone.addEventListener(eventName, () => dropzone.classList.add('dragover'));
      });
      
      ['dragleave', 'drop'].forEach((eventName) => {
        dropzone.addEventListener(eventName, () => dropzone.classList.remove('dragover'));
      });
      
      dropzone.addEventListener('click', () => fileInput.click());
      
      dropzone.addEventListener('drop', function(e) {
        const files = Array.from(e.dataTransfer?.files || []).filter((file) => file.type.startsWith('image/'));
        if (!files.length) {
          return;
        }
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(files[0]);
        fileInput.files = dataTransfer.files;
        handleFileSelection(files[0]);
      });
    }
    
    if (fileInput) {
      fileInput.addEventListener('change', function(e) {
        const file = e.target.files && e.target.files[0];
        handleFileSelection(file);
      });
    }
  }
  
  document.querySelectorAll('[data-upload-field]').forEach((container) => {
    initializeUploadField(container);
  });
  
  updateValueInputs();

  // Synchroniser le colorpicker et le champ texte
  const backgroundColorInput = document.getElementById('backgroundColor');
  const backgroundColorText = document.getElementById('backgroundColorText');
  
  backgroundColorInput.addEventListener('input', function() {
    backgroundColorText.value = this.value;
  });
  
  backgroundColorText.addEventListener('input', function() {
    if (/^#[0-9A-F]{6}$/i.test(this.value)) {
      backgroundColorInput.value = this.value;
    }
  });
  
  // Fonction pour convertir hex en rgba
  function hexToRgba(hex, alpha = 1) {
    const r = parseInt(hex.slice(1, 3), 16);
    const g = parseInt(hex.slice(3, 5), 16);
    const b = parseInt(hex.slice(5, 7), 16);
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
  }
  
  // Fonction pour extraire hex depuis rgba
  function rgbaToHex(rgba) {
    const match = rgba.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
    if (match) {
      const r = parseInt(match[1]).toString(16).padStart(2, '0');
      const g = parseInt(match[2]).toString(16).padStart(2, '0');
      const b = parseInt(match[3]).toString(16).padStart(2, '0');
      return `#${r}${g}${b}`;
    }
    return null;
  }
  
  // Synchroniser le colorpicker, le slider d'opacité et le champ texte pour la card
  const cardBackgroundColorInput = document.getElementById('cardBackgroundColor');
  const cardBackgroundColorText = document.getElementById('cardBackgroundColorText');
  const cardBackgroundOpacity = document.getElementById('cardBackgroundOpacity');
  const cardBackgroundOpacityValue = document.getElementById('cardBackgroundOpacityValue');
  
  // Fonction pour mettre à jour la valeur rgba dans le champ texte
  function updateCardColor() {
    const hex = cardBackgroundColorInput.value;
    const alpha = cardBackgroundOpacity.value / 100; // Convertir 0-100 en 0-1
    cardBackgroundColorText.value = hexToRgba(hex, alpha);
    cardBackgroundOpacityValue.textContent = cardBackgroundOpacity.value + '%';
  }
  
  // Initialiser : si c'est rgba, convertir en hex pour le colorpicker et initialiser le slider
  const initialValue = cardBackgroundColorText.value;
  if (initialValue.startsWith('rgba')) {
    const hex = rgbaToHex(initialValue);
    if (hex) {
      cardBackgroundColorInput.value = hex;
    }
    const alphaMatch = initialValue.match(/rgba\([^)]+,\s*([\d.]+)\)/);
    if (alphaMatch) {
      const alpha = parseFloat(alphaMatch[1]);
      cardBackgroundOpacity.value = Math.round(alpha * 100);
      cardBackgroundOpacityValue.textContent = cardBackgroundOpacity.value + '%';
    }
  } else if (initialValue.startsWith('#')) {
    // Si c'est hex, opacité à 100%
    cardBackgroundOpacity.value = 100;
    cardBackgroundOpacityValue.textContent = '100%';
  }
  
  // Quand le colorpicker change, mettre à jour le champ texte avec l'opacité actuelle
  cardBackgroundColorInput.addEventListener('input', function() {
    updateCardColor();
  });
  
  // Quand le slider d'opacité change, mettre à jour le champ texte
  cardBackgroundOpacity.addEventListener('input', function() {
    updateCardColor();
  });
  
  // Quand le champ texte change manuellement
  cardBackgroundColorText.addEventListener('input', function() {
    const value = this.value.trim();
    // Si c'est un hex valide, mettre à jour le colorpicker et remettre opacité à 100%
    if (/^#[0-9A-F]{6}$/i.test(value)) {
      cardBackgroundColorInput.value = value;
      cardBackgroundOpacity.value = 100;
      cardBackgroundOpacityValue.textContent = '100%';
    }
    // Si c'est rgba, extraire la couleur pour le colorpicker et l'opacité pour le slider
    else if (value.startsWith('rgba')) {
      const hex = rgbaToHex(value);
      if (hex) {
        cardBackgroundColorInput.value = hex;
      }
      const alphaMatch = value.match(/rgba\([^)]+,\s*([\d.]+)\)/);
      if (alphaMatch) {
        const alpha = parseFloat(alphaMatch[1]);
        cardBackgroundOpacity.value = Math.round(alpha * 100);
        cardBackgroundOpacityValue.textContent = cardBackgroundOpacity.value + '%';
      }
    }
  });
  
  // Fonction pour remplir le champ finalValue avant soumission
  function prepareFormSubmission() {
    const finalValueInput = document.getElementById('finalValue');
    if (contentTypeSelect.value === 'text') {
      finalValueInput.value = quill.root.innerHTML;
    } else {
      finalValueInput.value = document.getElementById('regularValue').value;
    }
  }
  
  // Gérer la suppression de l'icône
  const removeFaviconBtn = document.getElementById('removeFaviconBtn');
  const removeFaviconInput = document.getElementById('removeFavicon');
  const faviconFileInput = document.getElementById('faviconFile');
  
  if (removeFaviconBtn) {
    removeFaviconBtn.addEventListener('click', function() {
      if (confirm('Êtes-vous sûr de vouloir supprimer l\'icône ?')) {
        removeFaviconInput.value = 'true';
        faviconFileInput.disabled = true;
        // Préparer le formulaire avant soumission
        prepareFormSubmission();
        // Soumettre le formulaire
        document.getElementById('adminForm').submit();
      }
    });
  }
  
  // Gérer la suppression de l'image de fond
  const removeBackgroundImageBtn = document.getElementById('removeBackgroundImageBtn');
  const removeBackgroundImageInput = document.getElementById('removeBackgroundImage');
  const backgroundImageFileInput = document.getElementById('backgroundImageFile');
  
  if (removeBackgroundImageBtn) {
    removeBackgroundImageBtn.addEventListener('click', function() {
      if (confirm('Êtes-vous sûr de vouloir supprimer l\'image de fond ?')) {
        removeBackgroundImageInput.value = 'true';
        backgroundImageFileInput.disabled = true;
        // Préparer le formulaire avant soumission
        prepareFormSubmission();
        // Soumettre le formulaire
        document.getElementById('adminForm').submit();
      }
    });
  }
  
  // Afficher un avertissement quand une nouvelle image de fond est sélectionnée
  if (backgroundImageFileInput) {
    backgroundImageFileInput.addEventListener('change', function(e) {
      if (e.target.files && e.target.files.length > 0) {
        // Créer ou mettre à jour le message d'avertissement
        let warningDiv = document.getElementById('backgroundImageWarning');
        if (!warningDiv) {
          warningDiv = document.createElement('div');
          warningDiv.id = 'backgroundImageWarning';
          warningDiv.className = 'warning with-icon with-icon-block';
          backgroundImageFileInput.parentNode.insertBefore(warningDiv, backgroundImageFileInput.nextSibling);
        }
        warningDiv.innerHTML = '<i class="fa-solid fa-triangle-exclamation" aria-hidden="true"></i><span><strong>Note :</strong> Une nouvelle image de fond sera appliquée. La couleur de fond ne sera pas visible tant que cette image est active.</span>';
      }
    });
  }
  
  // Gérer l'affichage du champ de mot de passe public
  const publicPasswordEnabled = document.getElementById('publicPasswordEnabled');
  const publicPasswordGroup = document.getElementById('publicPasswordGroup');
  
  if (publicPasswordEnabled && publicPasswordGroup) {
    publicPasswordEnabled.addEventListener('change', function() {
      if (this.checked) {
        publicPasswordGroup.style.display = 'block';
      } else {
        publicPasswordGroup.style.display = 'none';
      }
    });
  }
  
  // Gérer l'affichage/masquage du mot de passe
  const togglePasswordVisibility = document.getElementById('togglePasswordVisibility');
  const publicPasswordInput = document.getElementById('publicPassword');
  
  if (togglePasswordVisibility && publicPasswordInput) {
    const togglePasswordText = togglePasswordVisibility.querySelector('span');
    const togglePasswordIcon = togglePasswordVisibility.querySelector('i');
    let isVisible = true; // Par défaut, le mot de passe est visible (type="text")
    
    togglePasswordVisibility.addEventListener('click', function() {
      if (isVisible) {
        // Masquer le mot de passe
        const currentValue = publicPasswordInput.value;
        publicPasswordInput.setAttribute('data-password', currentValue);
        publicPasswordInput.type = 'password';
        if (currentValue) {
          publicPasswordInput.value = '•'.repeat(currentValue.length);
        }
        if (togglePasswordText) {
          togglePasswordText.textContent = 'Afficher';
        }
        if (togglePasswordIcon) {
          togglePasswordIcon.classList.remove('fa-eye-slash');
          togglePasswordIcon.classList.add('fa-eye');
        }
        isVisible = false;
      } else {
        // Afficher le mot de passe
        const originalPassword = publicPasswordInput.getAttribute('data-password') || '';
        publicPasswordInput.type = 'text';
        publicPasswordInput.value = originalPassword;
        if (togglePasswordText) {
          togglePasswordText.textContent = 'Masquer';
        }
        if (togglePasswordIcon) {
          togglePasswordIcon.classList.remove('fa-eye');
          togglePasswordIcon.classList.add('fa-eye-slash');
        }
        isVisible = true;
      }
    });
  }
  
  // Avant la soumission du formulaire, copier le contenu dans le champ final
  document.getElementById('adminForm').addEventListener('submit', function(e) {
    prepareFormSubmission();
  });
  
  // Afficher le toaster si le paramètre success est présent dans l'URL
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('success') === 'true') {
    const toaster = document.getElementById('toaster');
    toaster.classList.add('show');
    
    // Masquer le toaster après 3 secondes
    setTimeout(function() {
      toaster.classList.remove('show');
      // Nettoyer l'URL en retirant le paramètre success
      window.history.replaceState({}, document.title, window.location.pathname);
    }, 3000);
  }
  
  // Fonction utilitaire pour copier dans le presse-papier
  async function copyToClipboard(text, button) {
    try {
      await navigator.clipboard.writeText(text);
      return true;
    } catch (err) {
      // Fallback pour les navigateurs qui ne supportent pas l'API Clipboard
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      
      try {
        document.execCommand('copy');
        document.body.removeChild(textarea);
        return true;
      } catch (err) {
        document.body.removeChild(textarea);
        return false;
      }
    }
  }
  
  // Fonction pour afficher la confirmation sur un bouton
  function showCopyConfirmation(button) {
    const originalHTML = button.innerHTML;
    button.innerHTML = '<i class="fa-solid fa-check"></i>';
    button.style.color = '#27ae60';
    
    setTimeout(function() {
      button.innerHTML = originalHTML;
      button.style.color = '';
    }, 2000);
  }
  
  // URL publique complète (passée par le serveur)
  const publicUrl = '<%= publicUrl %>';
  
  // Gérer le bouton de copie d'URL
  const copyUrlButton = document.getElementById('copyUrlButton');
  if (copyUrlButton) {
    copyUrlButton.addEventListener('click', async function() {
      const success = await copyToClipboard(publicUrl, copyUrlButton);
      
      if (success) {
        showCopyConfirmation(copyUrlButton);
      } else {
        alert('Impossible de copier automatiquement. URL : ' + publicUrl);
      }
    });
  }
  
  // Gérer le bouton de partage
  const shareButton = document.getElementById('shareButton');
  if (shareButton) {
    shareButton.addEventListener('click', async function() {
      // Créer le message formaté pour le partage
      const shareMessage = `Découvrez mon site personnel !\n\n${publicUrl}\n\nN'hésitez pas à le visiter !`;
      
      const success = await copyToClipboard(shareMessage, shareButton);
      
      if (success) {
        showCopyConfirmation(shareButton);
      } else {
        alert('Impossible de copier automatiquement. Voici le message à partager :\n\n' + shareMessage);
      }
    });
  }

  // Gestion des onglets Personnalisation / Administration
  (function() {
    const tabButtons = document.querySelectorAll('.admin-tab-button');
    const tabPanels = document.querySelectorAll('.admin-tab-panel');
    if (!tabButtons.length || !tabPanels.length) return;
    
    const siteHash = '<%= site ? site.hash : '' %>';
    const storageKey = siteHash ? `admin-tab-${siteHash}` : 'admin-tab';
    
    function activateTab(targetName) {
      tabButtons.forEach((button) => {
        const isActive = button.dataset.tabTarget === targetName;
        button.classList.toggle('active', isActive);
        button.setAttribute('aria-selected', isActive ? 'true' : 'false');
      });
      
      tabPanels.forEach((panel) => {
        const isActive = panel.dataset.tab === targetName;
        panel.classList.toggle('active', isActive);
        panel.toggleAttribute('hidden', !isActive);
      });
    }
    
    const savedTab = (() => {
      try {
        return localStorage.getItem(storageKey);
      } catch (_) {
        return null;
      }
    })();
    
    const defaultTab = tabButtons[0]?.dataset.tabTarget || 'customization';
    const initialTab = savedTab && document.querySelector(`[data-tab="${savedTab}"]`)
      ? savedTab
      : defaultTab;
    
    activateTab(initialTab);
    
    tabButtons.forEach((button) => {
      button.addEventListener('click', () => {
        const target = button.dataset.tabTarget;
        activateTab(target);
        try {
          localStorage.setItem(storageKey, target);
        } catch (_) {
          // Ignorer si localStorage n'est pas disponible
        }
      });
    });
  })();

  // Gestion du dropdown de personnalisation de la carte
  (function() {
    const toggleButton = document.getElementById('cardCustomizationToggle');
    const dropdown = document.getElementById('cardCustomizationDropdown');
    
    if (!toggleButton || !dropdown) return;
    
    function toggleDropdown() {
      const isExpanded = toggleButton.getAttribute('aria-expanded') === 'true';
      toggleButton.setAttribute('aria-expanded', !isExpanded);
      dropdown.classList.toggle('show', !isExpanded);
    }
    
    toggleButton.addEventListener('click', function(e) {
      e.stopPropagation();
      toggleDropdown();
    });
    
    // Fermer le dropdown quand on clique en dehors
    document.addEventListener('click', function(e) {
      if (!dropdown.contains(e.target) && !toggleButton.contains(e.target)) {
        toggleButton.setAttribute('aria-expanded', 'false');
        dropdown.classList.remove('show');
      }
    });
    
    // Empêcher la fermeture quand on clique dans le dropdown
    dropdown.addEventListener('click', function(e) {
      e.stopPropagation();
    });
  })();
</script>

