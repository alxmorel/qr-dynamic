<!-- QR Code Manager - Gestion du QR code avec qr-code-styling -->
<script>
(function() {
  if (typeof window.AdminStudio === 'undefined') {
    window.AdminStudio = {};
  }

  const studioRoot = document.getElementById('adminStudio');
  if (!studioRoot) return;

  // Import dynamique de qr-code-styling
  let QRCodeStyling;
  let qrCodeInstance = null;
  let qrCodeModalInstance = null;
  let currentConfig = {
    width: 300,
    height: 300,
    type: 'canvas',
    data: studioRoot.dataset.publicUrl || window.location.origin,
    dotsOptions: {
      color: '#000000',
      type: 'square'
    },
    backgroundOptions: {
      color: '#FFFFFF',
      hideBackgroundDots: false
    },
    cornersSquareOptions: {
      color: '#000000',
      type: 'square'
    },
    cornersDotOptions: {
      color: '#000000',
      type: 'square'
    },
    margin: 1,
    errorCorrectionLevel: 'M',
    imageOptions: {
      imageSize: 0.2,
      margin: 0
    }
  };
  
  let currentImageUrl = null;

  // Éléments DOM
  const qrCodePreview = document.getElementById('qrCodePreview');
  const qrCodeModalPreview = document.getElementById('qrCodeModalPreview');
  const qrCodeModal = document.getElementById('qrCodeModal');
  const qrCodeEditButton = document.getElementById('qrCodeEditButton');
  const qrCodeDownloadButton = document.getElementById('qrCodeDownloadButton');
  const qrCodeModalClose = document.getElementById('qrCodeModalClose');
  const qrCodeModalCancel = document.getElementById('qrCodeModalCancel');
  const qrCodeModalSave = document.getElementById('qrCodeModalSave');
  const qrCodeForm = document.getElementById('qrCodeCustomizationForm');
  const qrCodeImageInput = document.getElementById('qrCodeImage');
  const qrCodeImagePreview = document.getElementById('qrCodeImagePreview');
  const qrCodeImagePreviewImg = document.getElementById('qrCodeImagePreviewImg');
  const qrCodeImageRemove = document.getElementById('qrCodeImageRemove');
  const qrCodeImageSizeInput = document.getElementById('qrCodeImageSize');
  const qrCodeImageSizeValue = document.getElementById('qrCodeImageSizeValue');
  const qrCodeImageSizeGroup = document.getElementById('qrCodeImageSizeGroup');
  const qrCodeCornersSquareType = document.getElementById('qrCodeCornersSquareType');
  const qrCodeCornersSquareColor = document.getElementById('qrCodeCornersSquareColor');
  const qrCodeCornersSquareColorText = document.getElementById('qrCodeCornersSquareColorText');
  const qrCodeCornersDotType = document.getElementById('qrCodeCornersDotType');
  const qrCodeCornersDotColor = document.getElementById('qrCodeCornersDotColor');
  const qrCodeCornersDotColorText = document.getElementById('qrCodeCornersDotColorText');
  const qrCodeHideBackgroundDots = document.getElementById('qrCodeHideBackgroundDots');

  if (!qrCodePreview || !qrCodeModal) return;

  // Charger la bibliothèque qr-code-styling
  async function loadQRCodeLibrary() {
    try {
      // Utiliser la version locale d'abord, puis fallback sur CDN
      if (typeof window.QRCodeStyling === 'undefined') {
        const script = document.createElement('script');
        // Essayer d'abord la version locale
        script.src = '/js/qr-code-styling.js';
        script.async = true;
        return new Promise((resolve, reject) => {
          script.onload = () => {
            QRCodeStyling = window.QRCodeStyling;
            console.log('✓ qr-code-styling chargé depuis /js/qr-code-styling.js');
            resolve();
          };
          script.onerror = () => {
            console.warn('Impossible de charger depuis /js/, tentative avec le CDN...');
            // Fallback sur CDN si la version locale échoue
            const cdnScript = document.createElement('script');
            cdnScript.src = 'https://cdn.jsdelivr.net/npm/qr-code-styling@1.9.2/lib/qr-code-styling.js';
            cdnScript.async = true;
            cdnScript.onload = () => {
              QRCodeStyling = window.QRCodeStyling;
              console.log('✓ qr-code-styling chargé depuis le CDN');
              resolve();
            };
            cdnScript.onerror = () => {
              console.error('Erreur lors du chargement de qr-code-styling (local et CDN)');
              reject(new Error('Impossible de charger qr-code-styling'));
            };
            document.head.appendChild(cdnScript);
          };
          document.head.appendChild(script);
        });
      } else {
        QRCodeStyling = window.QRCodeStyling;
        return Promise.resolve();
      }
    } catch (error) {
      console.error('Erreur lors du chargement de qr-code-styling:', error);
      throw error;
    }
  }

  // Initialiser le QR code
  async function initQRCode() {
    await loadQRCodeLibrary();
    if (!QRCodeStyling) {
      console.error('QRCodeStyling n\'est pas disponible');
      return;
    }

    // QR code de prévisualisation (petit)
    qrCodeInstance = new QRCodeStyling({
      ...currentConfig,
      width: 200,
      height: 200
    });
    qrCodeInstance.append(qrCodePreview);

    // QR code de la modal (grand)
    qrCodeModalInstance = new QRCodeStyling({
      ...currentConfig
    });
    qrCodeModalInstance.append(qrCodeModalPreview);
  }

  // Mettre à jour la configuration
  function updateQRCodeConfig(newConfig) {
    // Si l'image est supprimée, s'assurer qu'elle est bien retirée de la config
    if (!newConfig.image && currentConfig.image) {
      delete currentConfig.image;
      delete currentConfig.imageOptions;
    }
    
    currentConfig = { ...currentConfig, ...newConfig };
    
    // Nettoyer les propriétés undefined
    if (!currentConfig.image) {
      delete currentConfig.image;
      delete currentConfig.imageOptions;
    }
    
    if (qrCodeInstance) {
      qrCodeInstance.update(currentConfig);
    }
    
    if (qrCodeModalInstance) {
      qrCodeModalInstance.update(currentConfig);
    }
  }

  // Synchroniser les champs du formulaire avec la configuration
  function syncFormToConfig() {
    const typeSelect = document.getElementById('qrCodeType');
    const colorInput = document.getElementById('qrCodeColor');
    const colorTextInput = document.getElementById('qrCodeColorText');
    const backgroundColorInput = document.getElementById('qrCodeBackgroundColor');
    const backgroundColorTextInput = document.getElementById('qrCodeBackgroundColorText');
    const marginInput = document.getElementById('qrCodeMargin');
    const marginValue = document.getElementById('qrCodeMarginValue');
    const widthInput = document.getElementById('qrCodeWidth');
    const errorCorrectionInput = document.getElementById('qrCodeErrorCorrectionLevel');

    if (typeSelect) typeSelect.value = currentConfig.dotsOptions.type || 'square';
    
    // Gérer les couleurs (supporte les dégradés, donc on utilise le texte)
    const dotsColor = currentConfig.dotsOptions.color || '#000000';
    if (colorTextInput) colorTextInput.value = dotsColor;
    // Essayer d'extraire la couleur hex si c'est un hex simple
    if (colorInput && /^#[0-9A-F]{6}$/i.test(dotsColor)) {
      colorInput.value = dotsColor;
    }
    
    const bgColor = currentConfig.backgroundOptions.color || '#FFFFFF';
    if (backgroundColorTextInput) backgroundColorTextInput.value = bgColor;
    if (backgroundColorInput && /^#[0-9A-F]{6}$/i.test(bgColor)) {
      backgroundColorInput.value = bgColor;
    }
    
    // Coins carrés
    if (qrCodeCornersSquareType) {
      qrCodeCornersSquareType.value = currentConfig.cornersSquareOptions.type || 'square';
    }
    const cornersSquareColor = currentConfig.cornersSquareOptions.color || '#000000';
    if (qrCodeCornersSquareColorText) qrCodeCornersSquareColorText.value = cornersSquareColor;
    if (qrCodeCornersSquareColor && /^#[0-9A-F]{6}$/i.test(cornersSquareColor)) {
      qrCodeCornersSquareColor.value = cornersSquareColor;
    }
    
    // Points des coins
    if (qrCodeCornersDotType) {
      qrCodeCornersDotType.value = currentConfig.cornersDotOptions.type || 'square';
    }
    const cornersDotColor = currentConfig.cornersDotOptions.color || '#000000';
    if (qrCodeCornersDotColorText) qrCodeCornersDotColorText.value = cornersDotColor;
    if (qrCodeCornersDotColor && /^#[0-9A-F]{6}$/i.test(cornersDotColor)) {
      qrCodeCornersDotColor.value = cornersDotColor;
    }
    
    // Masquer les points de fond
    if (qrCodeHideBackgroundDots) {
      qrCodeHideBackgroundDots.checked = currentConfig.backgroundOptions.hideBackgroundDots || false;
    }
    
    if (marginInput) marginInput.value = currentConfig.margin || 1;
    if (marginValue) marginValue.textContent = currentConfig.margin || 1;
    if (widthInput) widthInput.value = currentConfig.width || 300;
    if (errorCorrectionInput) errorCorrectionInput.value = currentConfig.errorCorrectionLevel || 'M';
    
    // Gérer l'image
    if (currentConfig.image && currentImageUrl) {
      if (qrCodeImagePreviewImg) {
        qrCodeImagePreviewImg.src = currentImageUrl;
      }
      if (qrCodeImagePreview) {
        qrCodeImagePreview.style.display = 'block';
      }
      if (qrCodeImageSizeGroup) {
        qrCodeImageSizeGroup.style.display = 'block';
      }
      if (qrCodeImageSizeInput && currentConfig.imageOptions) {
        const imageSizePercent = (currentConfig.imageOptions.imageSize || 0.2) * 100;
        qrCodeImageSizeInput.value = imageSizePercent;
      }
      if (qrCodeImageSizeValue && currentConfig.imageOptions) {
        const imageSizePercent = (currentConfig.imageOptions.imageSize || 0.2) * 100;
        qrCodeImageSizeValue.textContent = Math.round(imageSizePercent);
      }
    } else {
      if (qrCodeImagePreview) {
        qrCodeImagePreview.style.display = 'none';
      }
      if (qrCodeImageSizeGroup) {
        qrCodeImageSizeGroup.style.display = 'none';
      }
    }
  }

  // Synchroniser la configuration avec les champs du formulaire
  function syncConfigToForm() {
    const typeSelect = document.getElementById('qrCodeType');
    const colorInput = document.getElementById('qrCodeColor');
    const colorTextInput = document.getElementById('qrCodeColorText');
    const backgroundColorInput = document.getElementById('qrCodeBackgroundColor');
    const backgroundColorTextInput = document.getElementById('qrCodeBackgroundColorText');
    const marginInput = document.getElementById('qrCodeMargin');
    const widthInput = document.getElementById('qrCodeWidth');
    const errorCorrectionInput = document.getElementById('qrCodeErrorCorrectionLevel');

    // Récupérer les valeurs des couleurs (supporte les dégradés via le champ texte)
    const dotsColor = colorTextInput?.value.trim() || colorInput?.value || '#000000';
    const bgColor = backgroundColorTextInput?.value.trim() || backgroundColorInput?.value || '#FFFFFF';
    const cornersSquareColor = qrCodeCornersSquareColorText?.value.trim() || qrCodeCornersSquareColor?.value || dotsColor;
    const cornersDotColor = qrCodeCornersDotColorText?.value.trim() || qrCodeCornersDotColor?.value || dotsColor;
    
    const dotsType = typeSelect?.value || 'square';
    const cornersSquareType = qrCodeCornersSquareType?.value || 'square';
    const cornersDotType = qrCodeCornersDotType?.value || 'square';
    const hideBackgroundDots = qrCodeHideBackgroundDots?.checked || false;
    
    const newConfig = {
      dotsOptions: {
        ...currentConfig.dotsOptions,
        type: dotsType,
        color: dotsColor
      },
      backgroundOptions: {
        ...currentConfig.backgroundOptions,
        color: bgColor,
        hideBackgroundDots: hideBackgroundDots
      },
      cornersSquareOptions: {
        ...currentConfig.cornersSquareOptions,
        color: cornersSquareColor,
        type: cornersSquareType
      },
      cornersDotOptions: {
        ...currentConfig.cornersDotOptions,
        color: cornersDotColor,
        type: cornersDotType
      },
      margin: parseFloat(marginInput?.value || 1),
      width: parseInt(widthInput?.value || 300),
      height: parseInt(widthInput?.value || 300),
      errorCorrectionLevel: errorCorrectionInput?.value || 'M'
    };
    
    // Ajouter l'image si elle existe
    if (currentImageUrl) {
      const imageSizePercent = parseFloat(qrCodeImageSizeInput?.value || 20);
      const imageSize = imageSizePercent / 100; // Convertir en décimal (0.1 à 0.5)
      
      newConfig.image = currentImageUrl;
      newConfig.imageOptions = {
        imageSize: imageSize,
        margin: 0,
        crossOrigin: 'anonymous'
      };
    }

    updateQRCodeConfig(newConfig);
  }

  // Ouvrir la modal
  function openModal() {
    if (!qrCodeModal) return;
    qrCodeModal.setAttribute('aria-hidden', 'false');
    syncFormToConfig();
    document.body.style.overflow = 'hidden';
  }

  // Fermer la modal
  function closeModal() {
    if (!qrCodeModal) return;
    qrCodeModal.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
  }

  // Télécharger le QR code
  async function downloadQRCode() {
    if (!qrCodeInstance) return;
    
    try {
      const blob = await qrCodeInstance.getRawData('png');
      if (!blob) return;
      
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `qrcode-${studioRoot.dataset.siteHash || 'site'}.png`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    } catch (error) {
      console.error('Erreur lors du téléchargement:', error);
    }
  }

  // Événements
  if (qrCodeEditButton) {
    qrCodeEditButton.addEventListener('click', openModal);
  }

  if (qrCodeDownloadButton) {
    qrCodeDownloadButton.addEventListener('click', downloadQRCode);
  }

  if (qrCodeModalClose) {
    qrCodeModalClose.addEventListener('click', closeModal);
  }

  if (qrCodeModalCancel) {
    qrCodeModalCancel.addEventListener('click', closeModal);
  }

  if (qrCodeModalSave) {
    qrCodeModalSave.addEventListener('click', async () => {
      syncConfigToForm();
      const config = getConfig();
      
      if (!config) {
        console.error('Impossible de récupérer la configuration QR code');
        return;
      }
      
      // Désactiver le bouton pendant la sauvegarde
      qrCodeModalSave.disabled = true;
      const originalText = qrCodeModalSave.textContent;
      qrCodeModalSave.textContent = 'Enregistrement...';
      
      try {
        // Récupérer l'URL de la route depuis le formulaire
        const adminForm = document.getElementById('adminForm');
        if (!adminForm || !adminForm.action) {
          throw new Error('Formulaire admin non trouvé');
        }
        
        // Extraire hashUser et hashSite de l'URL du formulaire
        const formAction = adminForm.action;
        const match = formAction.match(/\/admin\/([^\/]+)\/sites\/([^\/]+)/);
        if (!match) {
          throw new Error('Impossible de déterminer l\'URL de sauvegarde');
        }
        
        const [, hashUser, hashSite] = match;
        const saveUrl = `/admin/${hashUser}/sites/${hashSite}/qr-code-config`;
        
        // Sauvegarder via AJAX
        const response = await fetch(saveUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ config: config })
        });
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ error: 'Erreur inconnue' }));
          throw new Error(errorData.error || 'Erreur lors de la sauvegarde');
        }
        
        const result = await response.json();
        
        // Sauvegarder aussi dans le formulaire pour la cohérence
        saveConfigToForm();
        
        // Afficher un message de succès
        const successMessage = document.createElement('div');
        successMessage.className = 'qr-code-save-success';
        successMessage.textContent = '✓ Configuration sauvegardée';
        successMessage.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #4caf50; color: white; padding: 12px 20px; border-radius: 4px; z-index: 10000; box-shadow: 0 2px 8px rgba(0,0,0,0.2);';
        document.body.appendChild(successMessage);
        
        setTimeout(() => {
          successMessage.remove();
        }, 3000);
        
        closeModal();
      } catch (error) {
        console.error('Erreur lors de la sauvegarde de la configuration QR code:', error);
        alert('Erreur lors de la sauvegarde: ' + error.message);
      } finally {
        // Réactiver le bouton
        qrCodeModalSave.disabled = false;
        qrCodeModalSave.textContent = originalText;
      }
    });
  }
  
  // Fonction pour sauvegarder la configuration dans le formulaire
  function saveConfigToForm() {
    try {
      const adminForm = document.getElementById('adminForm');
      if (!adminForm) {
        return;
      }
      
      const config = getConfig();
      if (config) {
        let qrCodeConfigInput = document.getElementById('qrCodeConfig');
        if (!qrCodeConfigInput) {
          qrCodeConfigInput = document.createElement('input');
          qrCodeConfigInput.type = 'hidden';
          qrCodeConfigInput.id = 'qrCodeConfig';
          qrCodeConfigInput.name = 'qrCodeConfig';
          adminForm.appendChild(qrCodeConfigInput);
        }
        qrCodeConfigInput.value = JSON.stringify(config);
      }
    } catch (e) {
      console.error('Erreur lors de la sauvegarde de la config QR code:', e);
    }
  }
  
  // Sauvegarder automatiquement la configuration à chaque modification (avec debounce)
  let saveConfigTimeout = null;
  const originalUpdateQRCodeConfig = updateQRCodeConfig;
  updateQRCodeConfig = function(newConfig) {
    originalUpdateQRCodeConfig(newConfig);
    // Sauvegarder dans le formulaire après chaque modification (avec debounce pour éviter trop de logs)
    if (saveConfigTimeout) {
      clearTimeout(saveConfigTimeout);
    }
    saveConfigTimeout = setTimeout(() => {
      saveConfigToForm();
    }, 300); // Attendre 300ms après la dernière modification
  };

  // Fermer la modal en cliquant sur l'overlay
  if (qrCodeModal) {
    const overlay = qrCodeModal.querySelector('.qr-code-modal__overlay');
    if (overlay) {
      overlay.addEventListener('click', closeModal);
    }
  }

  // Fermer la modal avec Escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && qrCodeModal?.getAttribute('aria-hidden') === 'false') {
      closeModal();
    }
  });

  // Écouter les changements du formulaire pour la mise à jour en temps réel
  if (qrCodeForm) {
    const formInputs = qrCodeForm.querySelectorAll('input, select');
    formInputs.forEach(input => {
      input.addEventListener('input', () => {
        syncConfigToForm();
      });
      input.addEventListener('change', () => {
        syncConfigToForm();
      });
    });

    // Synchroniser les champs de couleur
    const colorInput = document.getElementById('qrCodeColor');
    const colorTextInput = document.getElementById('qrCodeColorText');
    const backgroundColorInput = document.getElementById('qrCodeBackgroundColor');
    const backgroundColorTextInput = document.getElementById('qrCodeBackgroundColorText');

    if (colorInput && colorTextInput) {
      colorInput.addEventListener('input', (e) => {
        colorTextInput.value = e.target.value.toUpperCase();
        syncConfigToForm();
      });
      colorTextInput.addEventListener('input', (e) => {
        const value = e.target.value;
        // Permettre les dégradés CSS ou les couleurs hex
        if (/^#[0-9A-F]{6}$/i.test(value)) {
          colorInput.value = value;
        }
        syncConfigToForm();
      });
    }

    if (backgroundColorInput && backgroundColorTextInput) {
      backgroundColorInput.addEventListener('input', (e) => {
        backgroundColorTextInput.value = e.target.value.toUpperCase();
        syncConfigToForm();
      });
      backgroundColorTextInput.addEventListener('input', (e) => {
        const value = e.target.value;
        // Permettre les dégradés CSS ou les couleurs hex
        if (/^#[0-9A-F]{6}$/i.test(value)) {
          backgroundColorInput.value = value;
        }
        syncConfigToForm();
      });
    }
    
    // Synchroniser les couleurs des coins carrés
    if (qrCodeCornersSquareColor && qrCodeCornersSquareColorText) {
      qrCodeCornersSquareColor.addEventListener('input', (e) => {
        qrCodeCornersSquareColorText.value = e.target.value.toUpperCase();
        syncConfigToForm();
      });
      qrCodeCornersSquareColorText.addEventListener('input', (e) => {
        const value = e.target.value;
        if (/^#[0-9A-F]{6}$/i.test(value)) {
          qrCodeCornersSquareColor.value = value;
        }
        syncConfigToForm();
      });
    }
    
    // Synchroniser les couleurs des points des coins
    if (qrCodeCornersDotColor && qrCodeCornersDotColorText) {
      qrCodeCornersDotColor.addEventListener('input', (e) => {
        qrCodeCornersDotColorText.value = e.target.value.toUpperCase();
        syncConfigToForm();
      });
      qrCodeCornersDotColorText.addEventListener('input', (e) => {
        const value = e.target.value;
        if (/^#[0-9A-F]{6}$/i.test(value)) {
          qrCodeCornersDotColor.value = value;
        }
        syncConfigToForm();
      });
    }
    
    // Gérer le checkbox hideBackgroundDots
    if (qrCodeHideBackgroundDots) {
      qrCodeHideBackgroundDots.addEventListener('change', () => {
        syncConfigToForm();
      });
    }
    
    // Gérer les changements des types de coins
    if (qrCodeCornersSquareType) {
      qrCodeCornersSquareType.addEventListener('change', () => {
        syncConfigToForm();
      });
    }
    
    if (qrCodeCornersDotType) {
      qrCodeCornersDotType.addEventListener('change', () => {
        syncConfigToForm();
      });
    }

    // Synchroniser le range avec la valeur affichée
    const marginInput = document.getElementById('qrCodeMargin');
    const marginValue = document.getElementById('qrCodeMarginValue');
    if (marginInput && marginValue) {
      marginInput.addEventListener('input', (e) => {
        marginValue.textContent = e.target.value;
        syncConfigToForm();
      });
    }
    
    // Fonction pour compresser et redimensionner l'image
    function compressImage(file, maxWidth = 512, maxHeight = 512, quality = 0.8) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            
            // Calculer les nouvelles dimensions en conservant le ratio
            if (width > height) {
              if (width > maxWidth) {
                height = (height * maxWidth) / width;
                width = maxWidth;
              }
            } else {
              if (height > maxHeight) {
                width = (width * maxHeight) / height;
                height = maxHeight;
              }
            }
            
            canvas.width = width;
            canvas.height = height;
            
            // Dessiner l'image redimensionnée
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            // Convertir en base64 avec compression
            const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
            resolve(compressedDataUrl);
          };
          img.onerror = () => reject(new Error('Erreur lors du chargement de l\'image'));
          img.src = event.target.result;
        };
        reader.onerror = () => reject(new Error('Erreur lors de la lecture du fichier'));
        reader.readAsDataURL(file);
      });
    }
    
    // Gérer l'upload d'image
    if (qrCodeImageInput) {
      qrCodeImageInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (file) {
          // Vérifier que c'est une image
          if (!file.type.startsWith('image/')) {
            alert('Veuillez sélectionner un fichier image.');
            e.target.value = '';
            return;
          }
          
          try {
            // Compresser l'image avant de l'utiliser
            currentImageUrl = await compressImage(file, 512, 512, 0.8);
            
            // Afficher l'aperçu
            if (qrCodeImagePreviewImg) {
              qrCodeImagePreviewImg.src = currentImageUrl;
            }
            if (qrCodeImagePreview) {
              qrCodeImagePreview.style.display = 'block';
            }
            if (qrCodeImageSizeGroup) {
              qrCodeImageSizeGroup.style.display = 'block';
            }
            
            // Mettre à jour le QR code
            syncConfigToForm();
          } catch (error) {
            alert('Erreur lors de la compression de l\'image: ' + error.message);
            e.target.value = '';
          }
        }
      });
    }
    
    // Gérer la suppression de l'image
    if (qrCodeImageRemove) {
      qrCodeImageRemove.addEventListener('click', () => {
        currentImageUrl = null;
        if (qrCodeImageInput) {
          qrCodeImageInput.value = '';
        }
        if (qrCodeImagePreview) {
          qrCodeImagePreview.style.display = 'none';
        }
        if (qrCodeImageSizeGroup) {
          qrCodeImageSizeGroup.style.display = 'none';
        }
        if (qrCodeImagePreviewImg) {
          qrCodeImagePreviewImg.src = '';
        }
        
        // Mettre à jour le QR code
        syncConfigToForm();
      });
    }
    
    // Synchroniser la taille de l'image
    if (qrCodeImageSizeInput && qrCodeImageSizeValue) {
      qrCodeImageSizeInput.addEventListener('input', (e) => {
        qrCodeImageSizeValue.textContent = e.target.value;
        syncConfigToForm();
      });
    }
  }

  // Charger la configuration depuis le JSON initial si disponible
  function loadInitialConfig() {
    const configScript = document.getElementById('initialQrCodeConfig');
    if (configScript) {
      try {
        const configText = configScript.textContent.trim();
        
        if (!configText || configText === 'null' || configText === '') {
          return;
        }
        
        const savedConfig = JSON.parse(configText);
        
        if (savedConfig && typeof savedConfig === 'object') {
          // Restaurer la configuration sauvegardée (mais préserver l'URL publique)
          const publicUrl = currentConfig.data;
          
          // Fusionner la configuration sauvegardée avec la configuration par défaut
          currentConfig = {
            ...currentConfig,
            ...savedConfig,
            data: publicUrl, // Toujours utiliser l'URL publique actuelle
            type: 'canvas' // Toujours utiliser canvas
          };
          
          // Restaurer l'image si elle existe
          if (savedConfig.image) {
            currentImageUrl = savedConfig.image;
            // Afficher l'aperçu de l'image dans le formulaire
            if (qrCodeImagePreviewImg) {
              qrCodeImagePreviewImg.src = currentImageUrl;
            }
            if (qrCodeImagePreview) {
              qrCodeImagePreview.style.display = 'block';
            }
            if (qrCodeImageSizeGroup) {
              qrCodeImageSizeGroup.style.display = 'block';
            }
          } else {
            currentImageUrl = null;
          }
          
          // Réinitialiser les instances avec la configuration sauvegardée
          if (QRCodeStyling) {
            // Recréer les instances pour être sûr qu'elles utilisent la bonne config
            // Vider les conteneurs avant de recréer
            if (qrCodePreview) {
              qrCodePreview.innerHTML = '';
            }
            if (qrCodeModalPreview) {
              qrCodeModalPreview.innerHTML = '';
            }
            
            // Recréer l'instance de prévisualisation
            qrCodeInstance = new QRCodeStyling({
              ...currentConfig,
              width: 200,
              height: 200
            });
            if (qrCodePreview) {
              qrCodeInstance.append(qrCodePreview);
            }
            
            // Recréer l'instance de la modal
            qrCodeModalInstance = new QRCodeStyling({
              ...currentConfig
            });
            if (qrCodeModalPreview) {
              qrCodeModalInstance.append(qrCodeModalPreview);
            }
            
            // Synchroniser le formulaire avec la configuration chargée
            syncFormToConfig();
          }
        }
      } catch (e) {
        console.error('Erreur lors du chargement de la configuration QR code:', e);
      }
    }
  }

  // Obtenir la configuration actuelle pour la sauvegarde
  function getConfig() {
    try {
      // Récupérer la taille depuis le formulaire (la vraie taille, pas celle de la prévisualisation)
      const widthInput = document.getElementById('qrCodeWidth');
      const savedWidth = widthInput ? parseInt(widthInput.value) || currentConfig.width : currentConfig.width;
      
      // Créer une copie profonde de la configuration actuelle
      const config = JSON.parse(JSON.stringify(currentConfig));
      
      // Utiliser la taille réelle du formulaire
      config.width = savedWidth;
      config.height = savedWidth; // QR code carré
      
      // S'assurer que l'image est incluse si elle existe
      if (currentImageUrl) {
        config.image = currentImageUrl;
      } else {
        // Si pas d'image, retirer la propriété image de la config
        delete config.image;
        delete config.imageOptions;
      }
      
      // Retirer les propriétés qui ne doivent pas être sauvegardées
      delete config.type; // 'canvas' est toujours utilisé
      delete config.data; // L'URL publique est toujours recalculée
      
      // Log seulement en mode debug (commenté pour réduire le bruit)
      // console.log('Configuration QR code récupérée pour sauvegarde:', config);
      return config;
    } catch (e) {
      console.error('Erreur lors de la récupération de la configuration QR code:', e);
      return null;
    }
  }

  // Exposer l'API globale IMMÉDIATEMENT (avant l'initialisation asynchrone)
  window.AdminStudio.qrCode = {
    updateConfig: updateQRCodeConfig,
    download: downloadQRCode,
    openModal: openModal,
    closeModal: closeModal,
    getConfig: getConfig,
    saveConfigToForm: saveConfigToForm
  };

  // Initialiser le QR code au chargement
  initQRCode().then(() => {
    // Charger la configuration sauvegardée après l'initialisation
    loadInitialConfig();
  }).catch((error) => {
    console.error('Erreur lors de l\'initialisation du QR code:', error);
    // Essayer quand même de charger la config même si l'init a échoué
    loadInitialConfig();
  });
})();
</script>

