<!-- Preview Expand - Gestion du bouton d'ouverture/fermeture de l'aside -->
<script>
(function() {
  const previewExpandButton = document.getElementById('previewExpandButton');
  const previewAside = document.querySelector('.admin-studio__preview');
  
  if (!previewExpandButton || !previewAside) return;

  // Vérifier si on est en mode responsive (max-width: 930px)
  function isResponsiveMode() {
    return window.matchMedia('(max-width: 930px)').matches;
  }

  // Initialiser l'état : l'aside est ouvert par défaut en mode responsive
  let isOpen = isResponsiveMode();
  // Flag pour indiquer si l'utilisateur a explicitement fermé l'aside
  let userClosed = false;
  // Dernière largeur connue pour détecter les vrais changements de taille
  let lastWidth = window.innerWidth;

  function togglePreview() {
    isOpen = !isOpen;
    // Mettre à jour le flag : si l'utilisateur ferme, on le note
    userClosed = !isOpen;
    
    if (isOpen) {
      previewAside.classList.remove('preview-hidden');
      previewExpandButton.setAttribute('aria-label', 'Fermer la prévisualisation');
    } else {
      previewAside.classList.add('preview-hidden');
      previewExpandButton.setAttribute('aria-label', 'Ouvrir la prévisualisation');
    }
  }

  // Initialiser l'état au chargement
  if (isResponsiveMode()) {
    // En mode responsive, l'aside est ouvert par défaut
    previewAside.classList.remove('preview-hidden');
    previewExpandButton.setAttribute('aria-label', 'Fermer la prévisualisation');
  } else {
    // En mode desktop, le bouton n'est pas visible
    previewExpandButton.style.display = 'none';
  }

  previewExpandButton.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    togglePreview();
  });

  // Gérer le changement de taille d'écran
  window.addEventListener('resize', () => {
    const currentWidth = window.innerWidth;
    const isCurrentlyResponsive = isResponsiveMode();
    
    // Sur iOS, la barre d'adresse peut déclencher resize sans changer la largeur
    // On ignore les resize si la largeur n'a pas vraiment changé (seuil de 50px)
    const widthChanged = Math.abs(currentWidth - lastWidth) > 50;
    
    if (isCurrentlyResponsive) {
      previewExpandButton.style.display = 'flex';
      // Ne rouvrir automatiquement que si :
      // 1. L'utilisateur n'a pas explicitement fermé l'aside
      // 2. ET c'est un vrai changement de taille d'écran (pas juste la barre d'adresse iOS)
      if (!isOpen && !userClosed && widthChanged) {
        isOpen = true;
        userClosed = false; // Réinitialiser le flag car on rouvre automatiquement
        previewAside.classList.remove('preview-hidden');
        previewExpandButton.setAttribute('aria-label', 'Fermer la prévisualisation');
      }
    } else {
      previewExpandButton.style.display = 'none';
      // En mode desktop, toujours afficher l'aside
      previewAside.classList.remove('preview-hidden');
      userClosed = false; // Réinitialiser le flag en mode desktop
    }
    
    lastWidth = currentWidth;
  });

  // Fermer l'aside avec la touche Escape en mode responsive
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && isResponsiveMode() && isOpen) {
      togglePreview();
    }
  });
})();
</script>

