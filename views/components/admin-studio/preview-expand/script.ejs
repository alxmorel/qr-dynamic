<!-- Preview Expand - Gestion du bouton d'ouverture/fermeture de l'aside -->
<script>
(function() {
  const previewExpandButton = document.getElementById('previewExpandButton');
  const previewAside = document.querySelector('.admin-studio__preview');
  
  if (!previewExpandButton || !previewAside) return;

  // Vérifier si on est en mode responsive (max-width: 930px)
  function isResponsiveMode() {
    return window.matchMedia('(max-width: 930px)').matches;
  }

  // Initialiser l'état : l'aside est ouvert par défaut en mode responsive
  let isOpen = isResponsiveMode();
  // Flag pour indiquer si l'utilisateur a explicitement fermé l'aside
  let userClosed = false;
  // Timer pour debounce des événements resize
  let resizeTimer = null;

  function togglePreview() {
    isOpen = !isOpen;
    // Mettre à jour le flag : si l'utilisateur ferme, on le note
    userClosed = !isOpen;
    
    if (isOpen) {
      previewAside.classList.remove('preview-hidden');
      previewExpandButton.setAttribute('aria-label', 'Fermer la prévisualisation');
    } else {
      previewAside.classList.add('preview-hidden');
      previewExpandButton.setAttribute('aria-label', 'Ouvrir la prévisualisation');
    }
  }

  // Initialiser l'état au chargement
  if (isResponsiveMode()) {
    // En mode responsive, l'aside est ouvert par défaut
    previewAside.classList.remove('preview-hidden');
    previewExpandButton.setAttribute('aria-label', 'Fermer la prévisualisation');
  } else {
    // En mode desktop, le bouton n'est pas visible
    previewExpandButton.style.display = 'none';
  }

  previewExpandButton.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    togglePreview();
  });

  // Gérer le changement de taille d'écran
  window.addEventListener('resize', () => {
    // Debounce pour éviter les multiples déclenchements (notamment sur iOS lors du scroll)
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => {
      const isCurrentlyResponsive = isResponsiveMode();
      
      if (isCurrentlyResponsive) {
        previewExpandButton.style.display = 'flex';
        // Ne JAMAIS rouvrir automatiquement si l'utilisateur a explicitement fermé l'aside
        // Une fois fermé par l'utilisateur, l'aside reste fermé jusqu'à ce qu'il clique sur le bouton
        // Cela évite les réouvertures intempestives lors du scroll sur iOS
      } else {
        previewExpandButton.style.display = 'none';
        // En mode desktop, toujours afficher l'aside
        previewAside.classList.remove('preview-hidden');
        userClosed = false; // Réinitialiser le flag en mode desktop
      }
    }, 150); // Debounce de 150ms pour ignorer les resize rapides du scroll iOS
  });

  // Fermer l'aside avec la touche Escape en mode responsive
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && isResponsiveMode() && isOpen) {
      togglePreview();
    }
  });
})();
</script>

