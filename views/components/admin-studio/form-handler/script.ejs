<!-- Form Handler - Gestion du formulaire -->
<script>
(function() {
  if (typeof window.AdminStudio === 'undefined') {
    window.AdminStudio = {};
  }

  const quill = window.AdminStudio.quill;
  const contentTypeSelect = window.AdminStudio.contentTypeSelect;
  const regularValueInput = window.AdminStudio.regularValueInput;

  const adminForm = document.getElementById('adminForm');
  
  function prepareFormSubmission() {
    const finalValueInput = document.getElementById('finalValue');
    if (!finalValueInput) {
      return;
    }
    if (contentTypeSelect?.value === 'text') {
      finalValueInput.value = quill?.root.innerHTML || '';
    } else {
      finalValueInput.value = regularValueInput?.value || '';
    }
    
    // Ajouter la configuration QR code au formulaire
    if (window.AdminStudio && window.AdminStudio.qrCode && typeof window.AdminStudio.qrCode.getConfig === 'function') {
      try {
        const qrCodeConfig = window.AdminStudio.qrCode.getConfig();
        if (qrCodeConfig) {
          let qrCodeConfigInput = document.getElementById('qrCodeConfig');
          if (!qrCodeConfigInput) {
            qrCodeConfigInput = document.createElement('input');
            qrCodeConfigInput.type = 'hidden';
            qrCodeConfigInput.id = 'qrCodeConfig';
            qrCodeConfigInput.name = 'qrCodeConfig';
            adminForm.appendChild(qrCodeConfigInput);
          }
          qrCodeConfigInput.value = JSON.stringify(qrCodeConfig);
        }
      } catch (e) {
        console.error('Erreur lors de la récupération de la configuration QR code:', e);
      }
    }
  }

  if (adminForm) {
    // Écouter sur le bouton submit directement AVANT l'événement submit
    const submitButton = adminForm.querySelector('button[type="submit"]');
    if (submitButton) {
      // Utiliser capture phase pour être sûr d'être appelé en premier
      submitButton.addEventListener('click', function(e) {
        prepareFormSubmission();
      }, true);
    }
    
    // Écouter l'événement submit du formulaire
    adminForm.addEventListener('submit', function(e) {
      prepareFormSubmission();
    });
    
    // Aussi utiliser onsubmit comme fallback
    const originalOnSubmit = adminForm.onsubmit;
    adminForm.onsubmit = function(e) {
      prepareFormSubmission();
      if (originalOnSubmit) {
        return originalOnSubmit.call(this, e);
      }
      return true;
    };
  }

  // Gestion de la suppression du favicon
  const removeFaviconBtn = document.getElementById('removeFaviconBtn');
  const removeFaviconInput = document.getElementById('removeFavicon');
  const faviconFileInput = document.getElementById('faviconFile');
  const syncState = window.AdminStudio.syncState;

  removeFaviconBtn?.addEventListener('click', function() {
    if (confirm('Êtes-vous sûr de vouloir supprimer l\'icône ?')) {
      syncState('faviconPreview', null);
      syncState('favicon', null);
      if (removeFaviconInput) {
        removeFaviconInput.value = 'true';
      }
      if (faviconFileInput) {
        faviconFileInput.disabled = true;
      }
      prepareFormSubmission();
      adminForm?.submit();
    }
  });

  // Gestion de la suppression de l'image de fond
  const removeBackgroundImageBtn = document.getElementById('removeBackgroundImageBtn');
  const removeBackgroundImageInput = document.getElementById('removeBackgroundImage');
  const backgroundImageFileInput = document.getElementById('backgroundImageFile');

  removeBackgroundImageBtn?.addEventListener('click', function() {
    if (confirm('Supprimer l\'image de fond actuelle ?')) {
      syncState('backgroundImagePreview', null);
      syncState('backgroundImage', null);
      if (removeBackgroundImageInput) {
        removeBackgroundImageInput.value = 'true';
      }
      if (backgroundImageFileInput) {
        backgroundImageFileInput.disabled = true;
      }
      prepareFormSubmission();
      adminForm?.submit();
    }
  });

  window.AdminStudio.prepareFormSubmission = prepareFormSubmission;
})();
</script>

