<%- include('components/head') %>
<body>
  <%- include('components/toaster') %>
  
  <div class="container">
    <div class="card admin">
      <h2>
        <span>üìã Mes Sites</span>
        <a href="/logout" class="logout-link">D√©connexion</a>
      </h2>
      
      <% if (success) { %>
        <div style="background: #d4edda; color: #155724; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem;">
          ‚úÖ <%= success %>
        </div>
      <% } %>
      
      <% if (error) { %>
        <div style="background: #f8d7da; color: #721c24; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem;">
          ‚ùå <%= error %>
        </div>
      <% } %>
      
      <div style="margin-bottom: 1.5rem;">
        <button type="button" id="createSiteBtn" style="background-color: #6c5ce7; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer; font-size: 1rem;">
          ‚ûï Cr√©er un nouveau site
        </button>
      </div>
      
      <% if (sites && sites.length > 0) { %>
        <div style="display: grid; gap: 1rem;">
          <% sites.forEach(function(site) { %>
            <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; border: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
              <div style="flex: 1; min-width: 200px;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                  <h3 style="margin: 0; color: #333;">
                    <%= site.title || 'Site sans titre' %>
                  </h3>
                  <% if (site.isOwner) { %>
                    <span style="background: #6c5ce7; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">
                      üëë Propri√©taire
                    </span>
                  <% } else { %>
                    <span style="background: #17a2b8; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">
                      üë• Administrateur
                    </span>
                  <% } %>
                </div>
                <p style="margin: 0.25rem 0; color: #999; font-size: 0.85rem;">
                  Hash: <code style="background: white; padding: 0.15rem 0.4rem; border-radius: 3px; font-size: 0.8rem;"><%= site.hash %></code>
                </p>
                <p style="margin: 0.5rem 0; color: #666; font-size: 0.9rem;">
                  Cr√©√© le: <%= new Date(site.created_at).toLocaleDateString('fr-FR') %>
                </p>
                <p style="margin: 0.5rem 0; color: #666; font-size: 0.9rem;">
                  <a href="/<%= site.hash %>" target="_blank" style="color: #6c5ce7; text-decoration: underline;">
                    Voir le site public ‚Üí
                  </a>
                </p>
              </div>
              <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <a href="/admin/<%= userHash %>/sites/<%= site.hash %>" style="background-color: #6c5ce7; color: white; padding: 0.5rem 1rem; border-radius: 6px; text-decoration: none; display: inline-block;">
                  ‚öôÔ∏è Administrer
                </a>
                <% if (site.isOwner) { %>
                  <button type="button" class="delete-site-btn" data-site-hash="<%= site.hash %>" style="background-color: #e74c3c; color: white; padding: 0.5rem 1rem; border-radius: 6px; border: none; cursor: pointer;">
                    üóëÔ∏è Supprimer
                  </button>
                <% } %>
              </div>
            </div>
          <% }); %>
        </div>
      <% } else { %>
        <div style="text-align: center; padding: 2rem; color: #666;">
          <p>Vous n'avez pas encore de site.</p>
          <p>Cliquez sur "Cr√©er un nouveau site" pour commencer.</p>
        </div>
      <% } %>
    </div>
  </div>
  
  <script>
    // Cr√©er un nouveau site
    document.getElementById('createSiteBtn').addEventListener('click', async function() {
      if (!confirm('Voulez-vous cr√©er un nouveau site ?')) {
        return;
      }
      
      try {
        const response = await fetch('/admin/<%= userHash %>/sites', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          window.location.href = `/admin/<%= userHash %>/sites/${data.siteHash}`;
        } else {
          alert('Erreur lors de la cr√©ation du site: ' + (data.error || 'Erreur inconnue'));
        }
      } catch (error) {
        console.error('Erreur:', error);
        alert('Une erreur est survenue lors de la cr√©ation du site.');
      }
    });
    
    // Supprimer un site
    document.querySelectorAll('.delete-site-btn').forEach(function(btn) {
      btn.addEventListener('click', async function() {
        const siteHash = this.getAttribute('data-site-hash');
        
        if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce site ? Cette action est irr√©versible.')) {
          return;
        }
        
        try {
          const response = await fetch(`/admin/<%= userHash %>/sites/${siteHash}`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          
          const data = await response.json();
          
          if (response.ok && data.success) {
            window.location.href = '/admin/<%= userHash %>/sites?success=Site supprim√© avec succ√®s';
          } else {
            alert('Erreur lors de la suppression du site: ' + (data.error || 'Erreur inconnue'));
          }
        } catch (error) {
          console.error('Erreur:', error);
          alert('Une erreur est survenue lors de la suppression du site.');
        }
      });
    });
  </script>
</body>
</html>

