<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= requiresPassword ? 'Accès protégé' : (content && content.title ? content.title : 'Qr Dynamic') %></title>
  <% if (!requiresPassword && content && content.favicon) { %>
    <link rel="icon" type="image/x-icon" href="<%= content.favicon %>">
  <% } else { %>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="alternate icon" type="image/x-icon" href="/favicon.ico">
  <% } %>
  <link rel="stylesheet" href="/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <%
    const defaultContent = {
      type: "text",
      value: "Ce site n'a pas encore de contenu.",
      title: "Mon site personnel",
      backgroundColor: "#faf6ff",
      cardBackgroundColor: "#ffffff"
    };
    const initialContent = content || defaultContent;
    const isMediaCard = ["image", "gif", "video", "embed", "pdf"].includes(initialContent.type);
    const containerClasses = ["container", "preview-container"];
    if (initialContent.type === "video") {
      containerClasses.push("video-container");
    } else if (initialContent.type === "embed") {
      containerClasses.push("embed-container");
    }
    const cardClasses = ["card", "preview-card"];
    if (initialContent.type === "embed") {
      cardClasses.push("embed-card", "preview-card--embed");
    } else if (initialContent.type === "video") {
      cardClasses.push("video-card", "preview-card--video");
    }
    if (isMediaCard) {
      cardClasses.push("preview-card--media");
    }
    if (initialContent.type === "image" || initialContent.type === "gif") {
      cardClasses.push("preview-card--image");
    }
    if (initialContent.type === "pdf") {
      containerClasses.push("pdf-container");
      cardClasses.push("preview-card--pdf");
    }
    const resolvedCardTitle = (initialContent.title && initialContent.title.trim()) || "Mon site personnel";
  %>
  <style>
    body {
      <% if (requiresPassword) { %>
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      <% } else { %>
        <% if (initialContent && initialContent.backgroundImage && initialContent.backgroundImage.trim()) { %>
          background-image: url('<%= initialContent.backgroundImage.replace(/'/g, "\\'") %>');
          background-size: cover;
          background-position: center;
          background-repeat: no-repeat;
          background-attachment: fixed;
        <% } else { %>
          background-color: <%= initialContent.backgroundColor || '#faf6ff' %>;
        <% } %>
      <% } %>
      min-height: 100vh;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    @media (max-width: 768px) {
      body {
        /* padding: 1rem; */
      }
    }

    .password-modal {
      display: <%= requiresPassword ? 'flex' : 'none' %>;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }
    
    .password-modal-content {
      background-color: #ffffff;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      max-width: 400px;
      width: 90%;
      text-align: center;
    }
    
    .password-modal-content h2 {
      margin-top: 0;
      margin-bottom: 1rem;
      color: #333;
    }
    
    .password-modal-content p {
      color: #666;
      margin-bottom: 1.5rem;
    }
    
    .password-input-group {
      margin-bottom: 1.5rem;
    }
    
    .password-input-group input {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 1rem;
      box-sizing: border-box;
    }
    
    .password-input-group input:focus {
      outline: none;
      border-color: #6c5ce7;
    }
    
    .password-error {
      color: #e74c3c;
      margin-top: 0.5rem;
      font-size: 0.9rem;
      display: none;
    }
    
    .password-error.show {
      display: block;
    }
    
    .password-submit-btn {
      background-color: #6c5ce7;
      color: white;
      border: none;
      padding: 0.75rem 2rem;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .password-submit-btn:hover {
      background-color: #5a4fcf;
    }
    
    .password-submit-btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .public-preview {
      width: 100%;
      margin: 0;
    }
  </style>
</head>
<body>
  <% if (requiresPassword) { %>
  <div class="password-modal" id="passwordModal">
    <div class="password-modal-content">
      <h2 class="with-icon with-icon-block" style="justify-content: center;">
        <i class="fa-solid fa-lock" aria-hidden="true"></i>
        <span>Accès protégé</span>
      </h2>
      <p>Ce site est protégé par un mot de passe. Veuillez entrer le mot de passe pour continuer.</p>
      <form id="passwordForm">
        <div class="password-input-group">
          <input type="password" id="passwordInput" placeholder="Mot de passe" required autofocus />
          <div class="password-error" id="passwordError">Mot de passe incorrect</div>
        </div>
        <button type="submit" class="password-submit-btn" id="passwordSubmitBtn">Accéder</button>
      </form>
    </div>
  </div>
  <% } %>

  <main class="public-preview" id="mainContent" style="<%= requiresPassword ? 'display: none;' : '' %>">
    <div class="<%= containerClasses.join(' ') %>" id="publicPreviewContainer">
      <div class="<%= cardClasses.join(' ') %>" id="publicPreviewCard" style="background-color: <%= initialContent.cardBackgroundColor || '#ffffff' %>;">
        <p class="preview-card__title" id="publicPreviewTitle"><%= resolvedCardTitle %></p>
        <div class="preview-card__content" id="publicPreviewContent">
          <% if (initialContent.type === 'text') { %>
            <% if (initialContent.value) { %>
              <%- initialContent.value %>
            <% } else { %>
              <div class="preview-placeholder">Ajoutez du texte pour personnaliser votre page.</div>
            <% } %>
          <% } else if (initialContent.type === 'image') { %>
            <% if (initialContent.value) { %>
              <img class="preview-media" src="<%= initialContent.value %>" alt="<%= resolvedCardTitle %>">
            <% } else { %>
              <div class="preview-placeholder">Ajoutez une image pour la mettre en valeur.</div>
            <% } %>
          <% } else if (initialContent.type === 'gif') { %>
            <% if (initialContent.value) { %>
              <img class="preview-media preview-media--gif" src="<%= initialContent.value %>" alt="<%= resolvedCardTitle %>">
            <% } else { %>
              <div class="preview-placeholder">Recherchez et sélectionnez un GIF pour l'afficher.</div>
            <% } %>
          <% } else if (initialContent.type === 'video') { %>
            <% if (initialContent.value) { %>
              <div class="preview-iframe preview-iframe--video">
                <iframe src="<%= initialContent.value %>" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" allowfullscreen></iframe>
              </div>
            <% } else { %>
              <div class="preview-placeholder">Ajoutez un lien vidéo pour afficher un lecteur.</div>
            <% } %>
          <% } else if (initialContent.type === 'embed') { %>
            <% if (initialContent.value) { %>
              <div class="preview-iframe preview-iframe--embed">
                <iframe src="<%= initialContent.value %>" frameborder="0" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
              </div>
            <% } else { %>
              <div class="preview-placeholder">Ajoutez un code d'intégration pour prévisualiser votre contenu.</div>
            <% } %>
          <% } else if (initialContent.type === 'pdf') { %>
            <% if (initialContent.value) { %>
              <div class="preview-pdf">
                <iframe src="<%= initialContent.value %>#toolbar=1" frameborder="0" class="preview-pdf__iframe" allow="fullscreen"></iframe>
                <div class="preview-pdf__actions">
                  <a href="<%= initialContent.value %>" target="_blank" rel="noopener" class="preview-pdf__download">
                    <i class="fa-solid fa-download" aria-hidden="true"></i>
                    <span>Télécharger le PDF</span>
                  </a>
                </div>
              </div>
            <% } else { %>
              <div class="preview-placeholder">Ajoutez un PDF pour l'afficher dans la visionneuse.</div>
            <% } %>
          <% } else { %>
            <%- initialContent.value %>
          <% } %>
        </div>
      </div>
    </div>
  </main>

  <%- include('components/footer') %>

  <script>
    (function() {
      function buildPublicContentMarkup(payload) {
        const type = payload && payload.type ? payload.type : 'text';
        const rawValue = payload && payload.value ? payload.value : '';
        if (type === 'text') {
          return rawValue || '<div class="preview-placeholder">Ajoutez du texte pour personnaliser votre page.</div>';
        }
        if (type === 'image') {
          if (!rawValue) {
            return '<div class="preview-placeholder">Ajoutez une image pour la mettre en valeur.</div>';
          }
          return '<img src="' + rawValue + '" alt="Contenu visuel" class="preview-media">';
        }
        if (type === 'gif') {
          if (!rawValue) {
            return '<div class="preview-placeholder">Recherchez et sélectionnez un GIF pour l\'afficher.</div>';
          }
          return '<img src="' + rawValue + '" alt="GIF sélectionné" class="preview-media preview-media--gif">';
        }
        if (type === 'video') {
          if (!rawValue) {
            return '<div class="preview-placeholder">Ajoutez un lien vidéo pour afficher un lecteur.</div>';
          }
          return '' +
            '<div class="preview-iframe preview-iframe--video">' +
              '<iframe src="' + rawValue + '" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" allowfullscreen></iframe>' +
            '</div>';
        }
        if (type === 'embed') {
          if (!rawValue) {
            return "<div class=\"preview-placeholder\">Ajoutez un code d'intégration pour prévisualiser votre contenu.</div>";
          }
          return '' +
            '<div class="preview-iframe preview-iframe--embed">' +
              '<iframe src="' + rawValue + '" frameborder="0" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>' +
            '</div>';
        }
        if (type === 'pdf') {
          if (!rawValue) {
            return '<div class="preview-placeholder">Ajoutez un PDF pour l\'afficher dans la visionneuse.</div>';
          }
          return '' +
            '<div class="preview-pdf">' +
              '<iframe src="' + rawValue + '#toolbar=1" frameborder="0" class="preview-pdf__iframe" allow="fullscreen"></iframe>' +
              '<div class="preview-pdf__actions">' +
                '<a href="' + rawValue + '" target="_blank" rel="noopener" class="preview-pdf__download">' +
                  '<i class="fa-solid fa-download" aria-hidden="true"></i>' +
                  '<span>Télécharger le PDF</span>' +
                '</a>' +
              '</div>' +
            '</div>';
        }
        return rawValue || '<div class="preview-placeholder">Aucun contenu disponible.</div>';
      }

      function applyPublicPreview(payload) {
        if (!payload) return;
        const container = document.getElementById('publicPreviewContainer');
        const card = document.getElementById('publicPreviewCard');
        const contentTarget = document.getElementById('publicPreviewContent');
        const title = document.getElementById('publicPreviewTitle');

        if (!container || !card || !contentTarget) {
          return;
        }

        const type = payload.type || 'text';
        const isMedia = ['image', 'gif', 'video', 'embed', 'pdf'].includes(type);

        const containerClasses = ['container', 'preview-container'];
        if (type === 'video') {
          containerClasses.push('video-container');
        } else if (type === 'embed') {
          containerClasses.push('embed-container');
        } else if (type === 'pdf') {
          containerClasses.push('pdf-container');
        }
        container.className = containerClasses.join(' ');

        const cardClasses = ['card', 'preview-card'];
        if (type === 'embed') {
          cardClasses.push('embed-card', 'preview-card--embed');
        } else if (type === 'video') {
          cardClasses.push('video-card', 'preview-card--video');
        } else if (type === 'pdf') {
          cardClasses.push('preview-card--pdf');
        }
        if (isMedia) {
          cardClasses.push('preview-card--media');
        }
        if (type === 'image' || type === 'gif') {
          cardClasses.push('preview-card--image');
        }
        card.className = cardClasses.join(' ');
        card.style.backgroundColor = payload.cardBackgroundColor || '#ffffff';

        const resolvedTitle = (payload.title && payload.title.trim()) || 'Mon site personnel';
        if (title) {
          title.textContent = resolvedTitle;
        }
        // Aucun onglet/favicone public sur le site exposé

        contentTarget.innerHTML = buildPublicContentMarkup(payload);
      }

      window.PublicPreview = {
        apply: applyPublicPreview,
        buildContent: buildPublicContentMarkup
      };
    })();
  </script>

  <% if (requiresPassword) { %>
  <script>
    (function() {
      const passwordForm = document.getElementById('passwordForm');
      const passwordInput = document.getElementById('passwordInput');
      const passwordError = document.getElementById('passwordError');
      const passwordSubmitBtn = document.getElementById('passwordSubmitBtn');
      const passwordModal = document.getElementById('passwordModal');
      const mainContent = document.getElementById('mainContent');
      const siteHash = <%- JSON.stringify(siteHash || '') %>;
      const normalizedHash = siteHash ? encodeURIComponent(siteHash) : '';
      const contentEndpoint = normalizedHash ? `/${normalizedHash}/content` : '/content';
      const verifyEndpoint = normalizedHash ? `/${normalizedHash}/verify-password` : '/verify-password';

      if (!passwordForm) {
        return;
      }

      async function loadContent() {
        try {
          const response = await fetch(contentEndpoint, { credentials: 'same-origin' });
          const data = await response.json();

          if (data.content) {
            const content = data.content;

            document.title = content.title || 'Qr Dynamic';

            if (content.favicon) {
              const link = document.createElement('link');
              link.rel = 'icon';
              link.type = 'image/x-icon';
              link.href = content.favicon;
              document.head.appendChild(link);
            }

            const body = document.body;
            if (content.backgroundImage && content.backgroundImage.trim()) {
              // Échapper les guillemets simples dans l'URL pour éviter les problèmes
              const escapedUrl = content.backgroundImage.replace(/'/g, "\\'");
              body.style.backgroundImage = `url('${escapedUrl}')`;
              body.style.backgroundSize = 'cover';
              body.style.backgroundPosition = 'center';
              body.style.backgroundRepeat = 'no-repeat';
              body.style.backgroundAttachment = 'fixed';
              body.style.backgroundColor = '';
            } else {
              body.style.backgroundColor = content.backgroundColor || '#faf6ff';
              body.style.backgroundImage = '';
            }

            if (window.PublicPreview && typeof window.PublicPreview.apply === 'function') {
              window.PublicPreview.apply(content);
            }

            if (mainContent) {
              mainContent.style.display = '';
            }

            passwordModal.style.display = 'none';
          }
        } catch (error) {
          console.error('Erreur lors du chargement du contenu:', error);
          passwordError.textContent = 'Erreur lors du chargement du contenu. Veuillez réessayer.';
          passwordError.classList.add('show');
        }
      }

      passwordForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const password = passwordInput.value.trim();

        if (!password) {
          passwordError.textContent = 'Veuillez entrer un mot de passe';
          passwordError.classList.add('show');
          return;
        }

        passwordSubmitBtn.disabled = true;
        passwordSubmitBtn.textContent = 'Vérification...';
        passwordError.classList.remove('show');

        try {
          const response = await fetch(verifyEndpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ password })
          });

          const data = await response.json();

          if (response.ok && data.success) {
            await loadContent();
          } else {
            passwordError.textContent = data.error || 'Mot de passe incorrect';
            passwordError.classList.add('show');
            passwordInput.focus();
            passwordInput.select();
            passwordSubmitBtn.disabled = false;
            passwordSubmitBtn.textContent = 'Accéder';
          }
        } catch (error) {
          passwordError.textContent = 'Une erreur est survenue. Veuillez réessayer.';
          passwordError.classList.add('show');
          passwordSubmitBtn.disabled = false;
          passwordSubmitBtn.textContent = 'Accéder';
        }
      });

      passwordInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          passwordForm.dispatchEvent(new Event('submit'));
        }
      });
    })();
  </script>
  <% } %>

  <% if (!requiresPassword) { %>
  <script>
  (function() {
    // Générer un ID de session unique
    function getSessionId() {
      let sessionId = sessionStorage.getItem('analytics_session_id');
      if (!sessionId) {
        sessionId = 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        sessionStorage.setItem('analytics_session_id', sessionId);
      }
      return sessionId;
    }

    // Détecter le type d'appareil
    function getDeviceInfo() {
      const ua = navigator.userAgent;
      return {
        type: /Mobile|Android|iPhone|iPad/.test(ua) ? 'mobile' : 'desktop',
        browser: getBrowser(ua),
        os: getOS(ua)
      };
    }

    function getBrowser(ua) {
      if (ua.includes('Chrome') && !ua.includes('Edg')) return 'Chrome';
      if (ua.includes('Firefox')) return 'Firefox';
      if (ua.includes('Safari') && !ua.includes('Chrome')) return 'Safari';
      if (ua.includes('Edg')) return 'Edge';
      if (ua.includes('Opera') || ua.includes('OPR')) return 'Opera';
      return 'Unknown';
    }

    function getOS(ua) {
      if (ua.includes('Windows')) return 'Windows';
      if (ua.includes('Mac')) return 'macOS';
      if (ua.includes('Linux')) return 'Linux';
      if (ua.includes('Android')) return 'Android';
      if (ua.includes('iOS')) return 'iOS';
      return 'Unknown';
    }

    const siteHash = window.location.pathname.replace('/', '');
    if (!siteHash || siteHash === '') return; // Ignorer si pas de hash de site

    const sessionId = getSessionId();
    const startTime = Date.now();
    let pageViews = 1;
    let isBounce = true;
    let lastInteraction = Date.now();
    let heartbeatInterval = null;
    let sessionEnded = false;

    // Fonction pour envoyer la fin de session
    function sendVisitEnd(duration, finalPageViews, finalIsBounce) {
      if (sessionEnded) return; // Éviter les envois multiples
      sessionEnded = true;

      const data = JSON.stringify({
        sessionId: sessionId,
        duration: duration,
        pageViews: finalPageViews,
        isBounce: finalIsBounce
      });

      // Utiliser sendBeacon correctement avec un Blob
      if (navigator.sendBeacon) {
        const blob = new Blob([data], { type: 'application/json' });
        navigator.sendBeacon(`/${siteHash}/analytics/visit-end`, blob);
      } else {
        // Fallback pour les navigateurs qui ne supportent pas sendBeacon
        fetch(`/${siteHash}/analytics/visit-end`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: data,
          keepalive: true
        }).catch(err => console.error('Erreur tracking fin de session:', err));
      }
    }

    // Fonction pour calculer et envoyer la durée actuelle (heartbeat)
    function sendHeartbeat() {
      if (sessionEnded) return;
      
      const duration = Math.round((Date.now() - startTime) / 1000);
      const timeSinceLastInteraction = Date.now() - lastInteraction;
      
      // Si pas d'interaction depuis plus de 30 secondes, considérer comme rebond si durée < 10s
      let finalIsBounce = isBounce;
      if (timeSinceLastInteraction > 30000 && duration < 10) {
        finalIsBounce = true;
      }

      // Envoyer périodiquement la durée pour sauvegarder les données
      fetch(`/${siteHash}/analytics/visit-end`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          sessionId: sessionId,
          duration: duration,
          pageViews: pageViews,
          isBounce: finalIsBounce
        }),
        keepalive: true
      }).catch(err => {
        // Ignorer les erreurs silencieusement pour le heartbeat
        console.debug('Heartbeat error (normal si page fermée):', err);
      });
    }

    // Enregistrer la visite initiale
    fetch(`/${siteHash}/analytics/visit`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        sessionId: sessionId,
        userAgent: navigator.userAgent,
        referrer: document.referrer || null,
        device: getDeviceInfo()
      })
    }).catch(err => console.error('Erreur tracking visite:', err));

    // Tracker les clics sur les liens/CTAs
    document.addEventListener('click', function(e) {
      const target = e.target.closest('a, button');
      if (target) {
        isBounce = false;
        lastInteraction = Date.now();
        
        // Si c'est un lien externe ou un bouton, tracker comme événement CTA
        if (target.tagName === 'A' || target.classList.contains('cta') || target.tagName === 'BUTTON') {
          fetch(`/${siteHash}/analytics/event`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              sessionId: sessionId,
              eventType: 'cta_click',
              eventData: {
                href: target.href || null,
                text: target.textContent.trim().substring(0, 100),
                tagName: target.tagName
              }
            })
          }).catch(err => console.error('Erreur tracking événement:', err));
        }
      }
    });

    // Tracker les interactions (scroll, mouvement souris)
    let interactionTimeout;
    function markInteraction() {
      isBounce = false;
      lastInteraction = Date.now();
      clearTimeout(interactionTimeout);
      interactionTimeout = setTimeout(() => {
        pageViews++;
      }, 3000);
    }

    document.addEventListener('scroll', markInteraction, { passive: true });
    document.addEventListener('mousemove', markInteraction, { passive: true });
    document.addEventListener('touchstart', markInteraction, { passive: true });

    // Enregistrer la fin de session
    function endSession() {
      const duration = Math.round((Date.now() - startTime) / 1000);
      const timeSinceLastInteraction = Date.now() - lastInteraction;
      
      // Si pas d'interaction depuis plus de 30 secondes, considérer comme rebond si durée < 10s
      let finalIsBounce = isBounce;
      if (timeSinceLastInteraction > 30000 && duration < 10) {
        finalIsBounce = true;
      }

      sendVisitEnd(duration, pageViews, finalIsBounce);
    }

    // Écouter plusieurs événements pour maximiser les chances d'envoi
    window.addEventListener('beforeunload', endSession);
    window.addEventListener('pagehide', endSession);
    window.addEventListener('unload', endSession);
    
    // Pour les navigateurs mobiles (visibilitychange)
    document.addEventListener('visibilitychange', function() {
      if (document.visibilityState === 'hidden') {
        endSession();
      }
    });

    // Heartbeat : envoyer la durée toutes les 2 secondes pour sauvegarder les données
    heartbeatInterval = setInterval(function() {
      // Ne pas modifier isBounce ici - laisser la logique d'interaction le gérer
      lastInteraction = Date.now();
      sendHeartbeat();
    }, 2000); // Toutes les 2 secondes

    // Nettoyer l'intervalle si la page se ferme
    window.addEventListener('beforeunload', function() {
      if (heartbeatInterval) {
        clearInterval(heartbeatInterval);
      }
    });
  })();
  </script>
  <% } %>
</body>
</html>
