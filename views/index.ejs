<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= requiresPassword ? 'Accès protégé' : (content ? content.title : 'Qr Dynamic') %></title>
  <% if (!requiresPassword && content && content.favicon) { %>
    <link rel="icon" type="image/x-icon" href="<%= content.favicon %>">
  <% } else { %>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="alternate icon" type="image/x-icon" href="/favicon.ico">
  <% } %>
  <link rel="stylesheet" href="/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      <% if (requiresPassword) { %>
        /* Fond par défaut pour la popup de mot de passe */
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      <% } else if (content) { %>
        <% if (content.backgroundImage) { %>
          background-image: url('<%= content.backgroundImage %>');
          background-size: cover;
          background-position: center;
          background-repeat: no-repeat;
          background-attachment: fixed;
        <% } else { %>
          background-color: <%= content.backgroundColor || '#faf6ff' %>;
        <% } %>
      <% } else { %>
        background-color: #faf6ff;
      <% } %>
    }
    <% if (!requiresPassword && content) { %>
    .card {
      background-color: <%= content.cardBackgroundColor || '#ffffff' %> !important;
    }
    <% } %>
    
    /* Styles pour la popup de mot de passe */
    .password-modal {
      display: <%= requiresPassword ? 'flex' : 'none' %>;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }
    
    .password-modal-content {
      background-color: #ffffff;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      max-width: 400px;
      width: 90%;
      text-align: center;
    }
    
    .password-modal-content h2 {
      margin-top: 0;
      margin-bottom: 1rem;
      color: #333;
    }
    
    .password-modal-content p {
      color: #666;
      margin-bottom: 1.5rem;
    }
    
    .password-input-group {
      margin-bottom: 1.5rem;
    }
    
    .password-input-group input {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 1rem;
      box-sizing: border-box;
    }
    
    .password-input-group input:focus {
      outline: none;
      border-color: #6c5ce7;
    }
    
    .password-error {
      color: #e74c3c;
      margin-top: 0.5rem;
      font-size: 0.9rem;
      display: none;
    }
    
    .password-error.show {
      display: block;
    }
    
    .password-submit-btn {
      background-color: #6c5ce7;
      color: white;
      border: none;
      padding: 0.75rem 2rem;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .password-submit-btn:hover {
      background-color: #5a4fcf;
    }
    
    .password-submit-btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    
    .content-hidden {
      display: none;
    }
  </style>
</head>
<body>
  <!-- Popup de mot de passe -->
  <% if (requiresPassword) { %>
  <div class="password-modal" id="passwordModal">
    <div class="password-modal-content">
      <h2 class="with-icon with-icon-block" style="justify-content: center;">
        <i class="fa-solid fa-lock" aria-hidden="true"></i>
        <span>Accès protégé</span>
      </h2>
      <p>Ce site est protégé par un mot de passe. Veuillez entrer le mot de passe pour continuer.</p>
      <form id="passwordForm">
        <div class="password-input-group">
          <input type="password" id="passwordInput" placeholder="Mot de passe" required autofocus />
          <div class="password-error" id="passwordError">Mot de passe incorrect</div>
        </div>
        <button type="submit" class="password-submit-btn" id="passwordSubmitBtn">Accéder</button>
      </form>
    </div>
  </div>
  <% } %>
  
  <!-- Contenu du site (chargé dynamiquement après authentification) -->
  <div class="container" id="mainContent" style="<%= requiresPassword ? 'display: none;' : '' %>">
    <% if (!requiresPassword && content) { %>
    <div class="card<% if (content.type === "embed") { %> embed-card<% } %>">
      <% if (content.type === "text") { %>
        <div class="text"><%- content.value %></div>
      <% } %>
      <% if (content.type === "image") { %>
        <img class="media" src="<%= content.value %>" alt="image">
      <% } %>
      <% if (content.type === "video") { %>
        <div class="iframe-wrapper video">
          <iframe src="<%= content.value %>" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        </div>
      <% } %>
      <% if (content.type === "embed") { %>
        <div class="iframe-wrapper embed">
          <iframe src="<%= content.value %>" frameborder="0" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
        </div>
      <% } %>
    </div>
    <% } %>
  </div>
  
  <% if (requiresPassword) { %>
  <script>
    const passwordForm = document.getElementById('passwordForm');
    const passwordInput = document.getElementById('passwordInput');
    const passwordError = document.getElementById('passwordError');
    const passwordSubmitBtn = document.getElementById('passwordSubmitBtn');
    const passwordModal = document.getElementById('passwordModal');
    const mainContent = document.getElementById('mainContent');
    const siteHash = '<%= siteHash %>';
    
    // Fonction pour charger et afficher le contenu
    async function loadContent() {
      try {
        const response = await fetch(`/${siteHash}/content`);
        const data = await response.json();
        
        if (data.content) {
          const content = data.content;
          
          // Mettre à jour le titre
          document.title = content.title || 'Qr Dynamic';
          
          // Mettre à jour le favicon si présent
          if (content.favicon) {
            const link = document.createElement('link');
            link.rel = 'icon';
            link.type = 'image/x-icon';
            link.href = content.favicon;
            document.head.appendChild(link);
          }
          
          // Mettre à jour le fond
          const body = document.body;
          if (content.backgroundImage) {
            body.style.backgroundImage = `url('${content.backgroundImage}')`;
            body.style.backgroundSize = 'cover';
            body.style.backgroundPosition = 'center';
            body.style.backgroundRepeat = 'no-repeat';
            body.style.backgroundAttachment = 'fixed';
            body.style.backgroundColor = '';
          } else {
            body.style.backgroundColor = content.backgroundColor || '#faf6ff';
            body.style.backgroundImage = '';
          }
          
          // Créer le contenu de la carte
          let cardContent = '';
          if (content.type === 'text') {
            cardContent = `<div class="text">${content.value}</div>`;
          } else if (content.type === 'image') {
            cardContent = `<img class="media" src="${content.value}" alt="image">`;
          } else if (content.type === 'video') {
            cardContent = `<div class="iframe-wrapper video"><iframe src="${content.value}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>`;
          } else if (content.type === 'embed') {
            cardContent = `<div class="iframe-wrapper embed"><iframe src="${content.value}" frameborder="0" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe></div>`;
          }
          
          // Créer la carte avec le contenu
          const cardClass = content.type === 'embed' ? 'card embed-card' : 'card';
          const containerClass = content.type === 'embed' ? 'container embed-container' : 'container';
          
          // S'assurer que le conteneur a les bonnes classes et propriétés
          mainContent.className = containerClass;
          mainContent.style.display = 'flex';
          mainContent.style.minHeight = '100vh';
          mainContent.style.justifyContent = 'center';
          mainContent.style.alignItems = 'center';
          
          // Créer la carte avec le contenu
          mainContent.innerHTML = `<div class="${cardClass}" style="background-color: ${content.cardBackgroundColor || '#ffffff'} !important;">${cardContent}</div>`;
          
          // Masquer la popup
          passwordModal.style.display = 'none';
        }
      } catch (error) {
        console.error('Erreur lors du chargement du contenu:', error);
        passwordError.textContent = 'Erreur lors du chargement du contenu. Veuillez réessayer.';
        passwordError.classList.add('show');
      }
    }
    
    passwordForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const password = passwordInput.value.trim();
      
      if (!password) {
        passwordError.textContent = 'Veuillez entrer un mot de passe';
        passwordError.classList.add('show');
        return;
      }
      
      // Désactiver le bouton pendant la vérification
      passwordSubmitBtn.disabled = true;
      passwordSubmitBtn.textContent = 'Vérification...';
      passwordError.classList.remove('show');
      
      try {
        const response = await fetch(`/${siteHash}/verify-password`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ password: password })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          // Charger et afficher le contenu
          await loadContent();
        } else {
          // Afficher l'erreur
          passwordError.textContent = data.error || 'Mot de passe incorrect';
          passwordError.classList.add('show');
          passwordInput.focus();
          passwordInput.select();
          
          // Réactiver le bouton
          passwordSubmitBtn.disabled = false;
          passwordSubmitBtn.textContent = 'Accéder';
        }
      } catch (error) {
        passwordError.textContent = 'Une erreur est survenue. Veuillez réessayer.';
        passwordError.classList.add('show');
        passwordSubmitBtn.disabled = false;
        passwordSubmitBtn.textContent = 'Accéder';
      }
    });
    
    // Permettre la soumission avec Enter
    passwordInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        passwordForm.dispatchEvent(new Event('submit'));
      }
    });
  </script>
  <% } %>
</body>
</html>

