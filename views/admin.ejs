<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin</title>
  <% if (content.favicon) { %>
    <link rel="icon" type="image/x-icon" href="<%= content.favicon %>">
  <% } else { %>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="alternate icon" type="image/x-icon" href="/favicon.ico">
  <% } %>
  <link rel="stylesheet" href="/style.css">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Quill.js CSS -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
</head>
<body>
  <!-- Toaster de validation -->
  <div id="toaster" class="toaster">
    <div class="toaster-content">
      <span class="toaster-icon">‚úÖ</span>
      <span class="toaster-message">Site mis √† jour avec succ√®s !</span>
    </div>
  </div>
  
  <div class="container">
    <div class="card admin">
      <h2>
        <span>üéõÔ∏è Administration</span>
        <a href="/logout" class="logout-link">D√©connexion</a>
      </h2>
      
      <% if (site) { %>
        <div style="background: #e8f4f8; padding: 1rem; border-radius: 4px; margin-bottom: 1.5rem;">
          <p style="margin: 0.5rem 0;"><strong>Hash de votre site :</strong> <code style="background: white; padding: 0.25rem 0.5rem; border-radius: 3px;"><%= site.hash %></code></p>
          <p style="margin: 0.5rem 0; display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
            <strong>Lien public :</strong> 
            <a href="<%= publicUrl %>" target="_blank" style="color: #6c5ce7; text-decoration: underline;">
              <%= publicUrl %>
            </a>
            <button type="button" id="copyUrlButton" class="icon-button" title="Copier l'URL">
              <i class="fa-solid fa-copy"></i>
            </button>
            <button type="button" id="shareButton" class="icon-button" title="Partager avec message">
              <i class="fa-solid fa-share"></i>
            </button>
          </p>
        </div>
      <% } %>
      
      <% if (success) { %>
        <div style="background: #d4edda; color: #155724; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem;">
          ‚úÖ Site mis √† jour avec succ√®s !
        </div>
      <% } %>
      
      <form method="POST" action="/admin/<%= site ? site.hash : '' %>" id="adminForm" enctype="multipart/form-data">
        <div class="form-group">
          <label>Ic√¥ne du site (favicon)</label>
          <% if (content.favicon) { %>
            <div class="preview-section">
              <p>Ic√¥ne actuelle :</p>
              <img src="<%= content.favicon %>" alt="Ic√¥ne actuelle" />
              <button type="button" id="removeFaviconBtn" class="btn-danger">üóëÔ∏è Supprimer l'ic√¥ne</button>
              <input type="hidden" name="removeFavicon" id="removeFavicon" value="false" />
            </div>
          <% } %>
          <input type="file" name="faviconFile" id="faviconFile" accept="image/*,.ico,.svg" />
          <small>Format accept√© : ICO, PNG, SVG, JPG (max 10MB). Taille recommand√©e : 32x32px ou 64x64px</small>
        </div>
        
        <div class="form-group">
          <label>Titre du site</label>
          <input type="text" name="title" value="<%= content.title || '' %>" placeholder="üíù Surprise" />
        </div>
        
        <div class="form-group">
          <label>Type de contenu</label>
          <select name="type" id="contentType">
            <option value="text" <%= content.type==="text"?"selected":"" %>>Texte</option>
            <option value="image" <%= content.type==="image"?"selected":"" %>>Image (URL)</option>
            <option value="video" <%= content.type==="video"?"selected":"" %>>Vid√©o YouTube (URL ou embed)</option>
            <option value="embed" <%= content.type==="embed"?"selected":"" %>>Playlist Spotify (URL ou embed)</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Valeur</label>
          <div id="textEditorContainer" class="<%= content.type==="text"?"":"hidden" %>">
            <div id="textEditor"></div>
          </div>
          <input type="text" id="regularValue" value="<%= content.value %>" class="<%= content.type==="text"?"hidden":"" %>" />
          <input type="hidden" name="value" id="finalValue" />
        </div>
        
        <hr />
        
        <h3>üì¶ Personnalisation de la carte</h3>
        
        <div class="form-group">
          <label>Couleur de fond de la carte</label>
          <div class="color-controls">
            <input type="color" name="cardBackgroundColor" id="cardBackgroundColor" value="<%= content.cardBackgroundColor && content.cardBackgroundColor.startsWith('#') ? content.cardBackgroundColor : '#ffffff' %>" />
            <div class="color-input-wrapper">
              <input type="text" name="cardBackgroundColorValue" id="cardBackgroundColorText" value="<%= content.cardBackgroundColor || '#ffffff' %>" placeholder="#ffffff ou rgba(255,255,255,0.5)" />
            </div>
          </div>
          <div class="opacity-control">
            <label>Opacit√©</label>
            <input type="range" id="cardBackgroundOpacity" min="0" max="100" value="100" />
            <span id="cardBackgroundOpacityValue" class="opacity-value">100%</span>
          </div>
        </div>
        
        <hr />
        
        <h3>üé® Personnalisation du fond</h3>
        
        <div class="form-group">
          <label>Couleur de fond</label>
          <% if (content.backgroundImage) { %>
            <div class="warning">
              ‚ö†Ô∏è <strong>Note :</strong> Une image de fond est actuellement active. La couleur de fond ne sera pas visible tant que l'image de fond est pr√©sente.
            </div>
          <% } %>
          <div class="color-controls">
            <input type="color" name="backgroundColor" id="backgroundColor" value="<%= content.backgroundColor || '#faf6ff' %>" />
            <div class="color-input-wrapper">
              <input type="text" id="backgroundColorText" value="<%= content.backgroundColor || '#faf6ff' %>" placeholder="#faf6ff" />
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label>Image de fond</label>
          <% if (content.backgroundImage) { %>
            <div class="preview-section">
              <p>Image actuelle :</p>
              <img src="<%= content.backgroundImage %>" alt="Fond actuel" class="preview-large" />
              <button type="button" id="removeBackgroundImageBtn" class="btn-danger">üóëÔ∏è Supprimer l'image</button>
              <input type="hidden" name="removeBackgroundImage" id="removeBackgroundImage" value="false" />
            </div>
          <% } %>
          <input type="file" name="backgroundImageFile" id="backgroundImageFile" accept="image/*" />
          <small>Format accept√© : JPG, PNG, GIF (max 10MB)</small>
        </div>
        
        <hr />
        
        <h3>üîí Protection par mot de passe</h3>
        
        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 0.5rem;">
            <input type="checkbox" name="publicPasswordEnabled" id="publicPasswordEnabled" <%= publicPasswordEnabled ? "checked" : "" %> />
            <span>Activer la protection par mot de passe pour le site public</span>
          </label>
          <small>Si activ√©, les visiteurs devront entrer un mot de passe pour acc√©der √† votre site.</small>
        </div>
        
        <div class="form-group" id="publicPasswordGroup" style="<%= publicPasswordEnabled ? "" : "display: none;" %>">
          <label>Mot de passe public</label>
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <input type="text" name="publicPassword" id="publicPassword" value="<%= publicPassword || '' %>" placeholder="D√©finissez un mot de passe" style="flex: 1;" />
            <button type="button" id="togglePasswordVisibility" style="padding: 0.5rem 1rem; background: #6c5ce7; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">üëÅÔ∏è Masquer</button>
          </div>
          <small>D√©finissez un mot de passe que les visiteurs devront entrer pour acc√©der √† votre site.</small>
        </div>
        
        <button type="submit">üíæ Mettre √† jour</button>
      </form>
    </div>
  </div>
  
  <!-- Quill.js JS -->
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <script>
    // Initialiser Quill
    const quill = new Quill('#textEditor', {
      theme: 'snow',
      modules: {
        toolbar: [
          [{ 'header': [1, 2, 3, false] }],
          ['bold', 'italic', 'underline', 'strike'],
          [{ 'list': 'ordered'}, { 'list': 'bullet' }],
          [{ 'color': [] }, { 'background': [] }],
          [{ 'align': [] }],
          ['link'],
          ['clean']
        ]
      },
      placeholder: 'Saisissez votre texte ici...'
    });

    // Charger le contenu existant dans l'√©diteur si c'est du texte
    <% if (content.type === "text") { %>
    const existingContent = `<%- content.value %>`;
    if (existingContent) {
      quill.root.innerHTML = existingContent;
    }
    <% } %>

    // G√©rer le changement de type de contenu
    const contentTypeSelect = document.getElementById('contentType');
    const textEditorContainer = document.getElementById('textEditorContainer');
    const regularValueInput = document.getElementById('regularValue');
    
    contentTypeSelect.addEventListener('change', function() {
      if (this.value === 'text') {
        textEditorContainer.classList.remove('hidden');
        regularValueInput.classList.add('hidden');
      } else {
        textEditorContainer.classList.add('hidden');
        regularValueInput.classList.remove('hidden');
      }
    });

    // Synchroniser le colorpicker et le champ texte
    const backgroundColorInput = document.getElementById('backgroundColor');
    const backgroundColorText = document.getElementById('backgroundColorText');
    
    backgroundColorInput.addEventListener('input', function() {
      backgroundColorText.value = this.value;
    });
    
    backgroundColorText.addEventListener('input', function() {
      if (/^#[0-9A-F]{6}$/i.test(this.value)) {
        backgroundColorInput.value = this.value;
      }
    });
    
    // Fonction pour convertir hex en rgba
    function hexToRgba(hex, alpha = 1) {
      const r = parseInt(hex.slice(1, 3), 16);
      const g = parseInt(hex.slice(3, 5), 16);
      const b = parseInt(hex.slice(5, 7), 16);
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }
    
    // Fonction pour extraire hex depuis rgba
    function rgbaToHex(rgba) {
      const match = rgba.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
      if (match) {
        const r = parseInt(match[1]).toString(16).padStart(2, '0');
        const g = parseInt(match[2]).toString(16).padStart(2, '0');
        const b = parseInt(match[3]).toString(16).padStart(2, '0');
        return `#${r}${g}${b}`;
      }
      return null;
    }
    
    // Synchroniser le colorpicker, le slider d'opacit√© et le champ texte pour la card
    const cardBackgroundColorInput = document.getElementById('cardBackgroundColor');
    const cardBackgroundColorText = document.getElementById('cardBackgroundColorText');
    const cardBackgroundOpacity = document.getElementById('cardBackgroundOpacity');
    const cardBackgroundOpacityValue = document.getElementById('cardBackgroundOpacityValue');
    
    // Fonction pour mettre √† jour la valeur rgba dans le champ texte
    function updateCardColor() {
      const hex = cardBackgroundColorInput.value;
      const alpha = cardBackgroundOpacity.value / 100; // Convertir 0-100 en 0-1
      cardBackgroundColorText.value = hexToRgba(hex, alpha);
      cardBackgroundOpacityValue.textContent = cardBackgroundOpacity.value + '%';
    }
    
    // Initialiser : si c'est rgba, convertir en hex pour le colorpicker et initialiser le slider
    const initialValue = cardBackgroundColorText.value;
    if (initialValue.startsWith('rgba')) {
      const hex = rgbaToHex(initialValue);
      if (hex) {
        cardBackgroundColorInput.value = hex;
      }
      const alphaMatch = initialValue.match(/rgba\([^)]+,\s*([\d.]+)\)/);
      if (alphaMatch) {
        const alpha = parseFloat(alphaMatch[1]);
        cardBackgroundOpacity.value = Math.round(alpha * 100);
        cardBackgroundOpacityValue.textContent = cardBackgroundOpacity.value + '%';
      }
    } else if (initialValue.startsWith('#')) {
      // Si c'est hex, opacit√© √† 100%
      cardBackgroundOpacity.value = 100;
      cardBackgroundOpacityValue.textContent = '100%';
    }
    
    // Quand le colorpicker change, mettre √† jour le champ texte avec l'opacit√© actuelle
    cardBackgroundColorInput.addEventListener('input', function() {
      updateCardColor();
    });
    
    // Quand le slider d'opacit√© change, mettre √† jour le champ texte
    cardBackgroundOpacity.addEventListener('input', function() {
      updateCardColor();
    });
    
    // Quand le champ texte change manuellement
    cardBackgroundColorText.addEventListener('input', function() {
      const value = this.value.trim();
      // Si c'est un hex valide, mettre √† jour le colorpicker et remettre opacit√© √† 100%
      if (/^#[0-9A-F]{6}$/i.test(value)) {
        cardBackgroundColorInput.value = value;
        cardBackgroundOpacity.value = 100;
        cardBackgroundOpacityValue.textContent = '100%';
      }
      // Si c'est rgba, extraire la couleur pour le colorpicker et l'opacit√© pour le slider
      else if (value.startsWith('rgba')) {
        const hex = rgbaToHex(value);
        if (hex) {
          cardBackgroundColorInput.value = hex;
        }
        const alphaMatch = value.match(/rgba\([^)]+,\s*([\d.]+)\)/);
        if (alphaMatch) {
          const alpha = parseFloat(alphaMatch[1]);
          cardBackgroundOpacity.value = Math.round(alpha * 100);
          cardBackgroundOpacityValue.textContent = cardBackgroundOpacity.value + '%';
        }
      }
    });
    
    // Fonction pour remplir le champ finalValue avant soumission
    function prepareFormSubmission() {
      const finalValueInput = document.getElementById('finalValue');
      if (contentTypeSelect.value === 'text') {
        finalValueInput.value = quill.root.innerHTML;
      } else {
        finalValueInput.value = document.getElementById('regularValue').value;
      }
    }
    
    // G√©rer la suppression de l'ic√¥ne
    const removeFaviconBtn = document.getElementById('removeFaviconBtn');
    const removeFaviconInput = document.getElementById('removeFavicon');
    const faviconFileInput = document.getElementById('faviconFile');
    
    if (removeFaviconBtn) {
      removeFaviconBtn.addEventListener('click', function() {
        if (confirm('√ätes-vous s√ªr de vouloir supprimer l\'ic√¥ne ?')) {
          removeFaviconInput.value = 'true';
          faviconFileInput.disabled = true;
          // Pr√©parer le formulaire avant soumission
          prepareFormSubmission();
          // Soumettre le formulaire
          document.getElementById('adminForm').submit();
        }
      });
    }
    
    // G√©rer la suppression de l'image de fond
    const removeBackgroundImageBtn = document.getElementById('removeBackgroundImageBtn');
    const removeBackgroundImageInput = document.getElementById('removeBackgroundImage');
    const backgroundImageFileInput = document.getElementById('backgroundImageFile');
    
    if (removeBackgroundImageBtn) {
      removeBackgroundImageBtn.addEventListener('click', function() {
        if (confirm('√ätes-vous s√ªr de vouloir supprimer l\'image de fond ?')) {
          removeBackgroundImageInput.value = 'true';
          backgroundImageFileInput.disabled = true;
          // Pr√©parer le formulaire avant soumission
          prepareFormSubmission();
          // Soumettre le formulaire
          document.getElementById('adminForm').submit();
        }
      });
    }
    
    // Afficher un avertissement quand une nouvelle image de fond est s√©lectionn√©e
    if (backgroundImageFileInput) {
      backgroundImageFileInput.addEventListener('change', function(e) {
        if (e.target.files && e.target.files.length > 0) {
          // Cr√©er ou mettre √† jour le message d'avertissement
          let warningDiv = document.getElementById('backgroundImageWarning');
          if (!warningDiv) {
            warningDiv = document.createElement('div');
            warningDiv.id = 'backgroundImageWarning';
            warningDiv.className = 'warning';
            backgroundImageFileInput.parentNode.insertBefore(warningDiv, backgroundImageFileInput.nextSibling);
          }
          warningDiv.innerHTML = '‚ö†Ô∏è <strong>Note :</strong> Une nouvelle image de fond sera appliqu√©e. La couleur de fond ne sera pas visible tant que cette image est active.';
        }
      });
    }
    
    // G√©rer l'affichage du champ de mot de passe public
    const publicPasswordEnabled = document.getElementById('publicPasswordEnabled');
    const publicPasswordGroup = document.getElementById('publicPasswordGroup');
    
    if (publicPasswordEnabled && publicPasswordGroup) {
      publicPasswordEnabled.addEventListener('change', function() {
        if (this.checked) {
          publicPasswordGroup.style.display = 'block';
        } else {
          publicPasswordGroup.style.display = 'none';
        }
      });
    }
    
    // G√©rer l'affichage/masquage du mot de passe
    const togglePasswordVisibility = document.getElementById('togglePasswordVisibility');
    const publicPasswordInput = document.getElementById('publicPassword');
    
    if (togglePasswordVisibility && publicPasswordInput) {
      let isVisible = true; // Par d√©faut, le mot de passe est visible (type="text")
      
      togglePasswordVisibility.addEventListener('click', function() {
        if (isVisible) {
          // Masquer le mot de passe
          const currentValue = publicPasswordInput.value;
          publicPasswordInput.setAttribute('data-password', currentValue);
          publicPasswordInput.type = 'password';
          if (currentValue) {
            publicPasswordInput.value = '‚Ä¢'.repeat(currentValue.length);
          }
          togglePasswordVisibility.textContent = 'üëÅÔ∏è Afficher';
          isVisible = false;
        } else {
          // Afficher le mot de passe
          const originalPassword = publicPasswordInput.getAttribute('data-password') || '';
          publicPasswordInput.type = 'text';
          publicPasswordInput.value = originalPassword;
          togglePasswordVisibility.textContent = 'üëÅÔ∏è Masquer';
          isVisible = true;
        }
      });
    }
    
    // Avant la soumission du formulaire, copier le contenu dans le champ final
    document.getElementById('adminForm').addEventListener('submit', function(e) {
      prepareFormSubmission();
    });
    
    // Afficher le toaster si le param√®tre success est pr√©sent dans l'URL
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('success') === 'true') {
      const toaster = document.getElementById('toaster');
      toaster.classList.add('show');
      
      // Masquer le toaster apr√®s 3 secondes
      setTimeout(function() {
        toaster.classList.remove('show');
        // Nettoyer l'URL en retirant le param√®tre success
        window.history.replaceState({}, document.title, window.location.pathname);
      }, 3000);
    }
    
    // Fonction utilitaire pour copier dans le presse-papier
    async function copyToClipboard(text, button) {
      try {
        await navigator.clipboard.writeText(text);
        return true;
      } catch (err) {
        // Fallback pour les navigateurs qui ne supportent pas l'API Clipboard
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        
        try {
          document.execCommand('copy');
          document.body.removeChild(textarea);
          return true;
        } catch (err) {
          document.body.removeChild(textarea);
          return false;
        }
      }
    }
    
    // Fonction pour afficher la confirmation sur un bouton
    function showCopyConfirmation(button) {
      const originalHTML = button.innerHTML;
      button.innerHTML = '<i class="fa-solid fa-check"></i>';
      button.style.color = '#27ae60';
      
      setTimeout(function() {
        button.innerHTML = originalHTML;
        button.style.color = '';
      }, 2000);
    }
    
    // URL publique compl√®te (pass√©e par le serveur)
    const publicUrl = '<%= publicUrl %>';
    
    // G√©rer le bouton de copie d'URL
    const copyUrlButton = document.getElementById('copyUrlButton');
    if (copyUrlButton) {
      copyUrlButton.addEventListener('click', async function() {
        const success = await copyToClipboard(publicUrl, copyUrlButton);
        
        if (success) {
          showCopyConfirmation(copyUrlButton);
        } else {
          alert('Impossible de copier automatiquement. URL : ' + publicUrl);
        }
      });
    }
    
    // G√©rer le bouton de partage
    const shareButton = document.getElementById('shareButton');
    if (shareButton) {
      shareButton.addEventListener('click', async function() {
        // Cr√©er le message format√© pour le partage
        const shareMessage = `üéâ D√©couvrez mon site personnel !\n\n${publicUrl}\n\nN'h√©sitez pas √† le visiter ! üòä`;
        
        const success = await copyToClipboard(shareMessage, shareButton);
        
        if (success) {
          showCopyConfirmation(shareButton);
        } else {
          alert('Impossible de copier automatiquement. Voici le message √† partager :\n\n' + shareMessage);
        }
      });
    }
  </script>
</body>
</html>

